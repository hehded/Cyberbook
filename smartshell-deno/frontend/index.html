<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PC Map ‚Äî Booking</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        /* =========================
           THEME (palette & effects)
           ========================= */
        :root {
            /* Base */
            --bg: #0b1220;
            --bg-2: #0a0f1a;
            --card: #0f1724;
            --muted: #9fb1c5;
            --text: #eaf2fb;

            /* Accents */
            --accent: #7c7ffd;
            /* —Å–ª–µ–≥–∫–∞ —Ç–µ–ø–ª–µ–µ, –ª—É—á—à–µ –≤–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ —Ç—ë–º–Ω–æ–º —Ñ–æ–Ω–µ */
            --accent-2: #5c5fff;
            --accent-3: #a58fff;

            /* Status */
            --free: #10b981;
            --busy: #3b82f6;
            --booked: #f59e0b;

            /* Surfaces */
            --glass: rgba(255, 255, 255, 0.04);
            --glass-2: rgba(255, 255, 255, 0.06);
            --border: rgba(255, 255, 255, 0.08);
            --border-2: rgba(255, 255, 255, 0.12);

            /* Shadows / blurs */
            --shadow-1: 0 8px 24px rgba(10, 17, 32, 0.45);
            --shadow-2: 0 18px 48px rgba(10, 17, 32, 0.55);
            --ring: 0 0 0 3px rgba(124, 127, 253, 0.15);
            --blur: saturate(140%) blur(10px);
        }

        /* Reset & base */
        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            color: var(--text);
            background:
                radial-gradient(1200px 800px at 10% -10%, rgba(124, 127, 253, 0.12), transparent 50%),
                radial-gradient(900px 600px at 100% 0%, rgba(99, 102, 241, 0.10), transparent 45%),
                linear-gradient(180deg, #071224 0%, #060e1d 100%);
            -webkit-font-smoothing: antialiased;
        }

        /* Subtle noise overlay for depth */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/fi%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.025'/%3E%3C/svg%3E");
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 24px auto;
            padding: 18px;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
        }

        /* Header */
        .header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(124, 127, 253, 0.08), rgba(99, 102, 241, 0.04));
            border-radius: 16px;
            border: 1px solid rgba(124, 127, 253, 0.12);
            box-shadow: 0 8px 32px rgba(10, 17, 32, 0.25);
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .h1 {
            font-size: 20px;
            margin: 0;
            letter-spacing: .2px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .small {
            font-size: 13px;
            color: var(--muted);
            opacity: 0.85;
        }

        /* Controls */
        .controls {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
            border: 1px solid var(--border);
            padding: 9px 13px;
            border-radius: 12px;
            color: var(--text);
            cursor: pointer;
            transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
            box-shadow: 0 2px 0 rgba(255, 255, 255, 0.04) inset, var(--shadow-1);
            backdrop-filter: var(--blur);
        }

        .btn:hover {
            transform: translateY(-1px);
            background: var(--glass-2);
            border-color: var(--border-2)
        }

        .btn:active {
            transform: translateY(0) scale(.98)
        }

        .btn.primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border: 1px solid rgba(124, 127, 253, .45);
            box-shadow: 0 8px 22px rgba(124, 127, 253, .22), var(--shadow-1);
        }

        .btn.primary:hover {
            background: linear-gradient(135deg, var(--accent-3), var(--accent));
            box-shadow: 0 10px 26px rgba(124, 127, 253, .28), var(--shadow-2);
        }

        /* Cards */
        .card {
            background:
                linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02)),
                linear-gradient(0deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 18px;
            border-radius: 16px;
            backdrop-filter: var(--blur);
            box-shadow: var(--shadow-1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            border-color: rgba(124, 127, 253, 0.2);
            box-shadow: 0 12px 40px rgba(10, 17, 32, 0.4), 0 0 0 1px rgba(124, 127, 253, 0.1) inset;
        }

        .card:hover::before {
            opacity: 1;
        }

        /* Map */
        .mapWrap {
            height: 72vh;
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.06) inset, var(--shadow-2);
        }

        .mapWrap::after {
            /* –ª—ë–≥–∫–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞ –ø–æ –∫—Ä–∞—è–º, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∞ –≤—ã–≥–ª—è–¥–µ–ª–∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ */
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            box-shadow: inset 0 0 120px rgba(0, 0, 0, 0.35);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 45vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 4px;
            scrollbar-gutter: stable;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--accent), var(--accent-2));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .item:hover {
            transform: translateY(-1px);
            border-color: rgba(124, 127, 253, 0.18);
            box-shadow: 0 8px 24px rgba(10, 17, 32, 0.3), 0 0 0 1px rgba(124, 127, 253, 0.08) inset;
            background: linear-gradient(135deg, rgba(124, 127, 253, 0.06), rgba(99, 102, 241, 0.03));
        }

        .item:hover::before {
            opacity: 1;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 13px;
            color: var(--muted)
        }

        .kv {
            display: flex;
            gap: 8px;
            align-items: center
        }

        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(2, 6, 23, 0.85);
            z-index: 200;
            backdrop-filter: blur(16px) saturate(180%);
            animation: fadeIn .3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        .modalCard {
            width: 100%;
            max-width: 560px;
            background:
                linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(11, 18, 32, 0.95)),
                linear-gradient(0deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.03));
            padding: 28px;
            border-radius: 20px;
            border: 1px solid rgba(124, 127, 253, 0.15);
            box-shadow:
                0 24px 64px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset,
                0 0 48px rgba(124, 127, 253, 0.12);
            animation: modalSlideIn .35s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .modalCard::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3));
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(.94);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal h3 {
            margin: 0 0 20px 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text), var(--muted));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Inputs */
        .form-row {
            display: flex;
            gap: 8px
        }

        .input,
        select,
        textarea {
            width: 100%;
            padding: 12px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, #0a1322, #0b1526);
            color: var(--text);
            transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
            margin-bottom: 12px;
            box-shadow: inset 0 -2px 0 rgba(255, 255, 255, 0.02);
        }

        .input::placeholder,
        textarea::placeholder {
            color: rgba(159, 177, 197, .55)
        }

        .input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: rgba(124, 127, 253, .55);
            box-shadow: var(--ring);
        }

        /* Tooltip */
        .tooltip {
            position: fixed !important;
            /* –±—ã–ª–æ absolute, –º–µ–Ω—è–µ–º –Ω–∞ fixed */
            pointer-events: none;
            background: rgba(7, 18, 38, 0.98);
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.45);
            max-width: 280px;
            line-height: 1.35;
            z-index: 1000;
        }

        .tooltip::after {
            display: none;
            /* –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫—É, –æ–Ω–∞ –º–µ—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é */
        }

        /* PC Info Modal tweaks */
        .pc-info-modal .modalCard {
            max-width: 440px;
        }

        .pc-info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 14px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.015));
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.07);
        }

        .pc-status-icon {
            font-size: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .pc-status-icon.free {
            background: rgba(16, 185, 129, 0.12);
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.18) inset
        }

        .pc-status-icon.busy {
            background: rgba(59, 130, 246, 0.12);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.18) inset
        }

        .pc-status-icon.booked {
            background: rgba(245, 158, 11, 0.12);
            box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.18) inset
        }

        .booking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .booking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(245, 158, 11, 0.24);
        }

        .booking-time {
            font-weight: 600;
            color: var(--booked)
        }

        .booking-client {
            font-size: 13px;
            color: var(--muted)
        }

        /* Responsive */
        @media(max-width:1200px) {
            .container {
                grid-template-columns: 1fr;
                padding: 12px;
            }

            #leftSidebar {
                order: 2;
            }

            main {
                order: 1;
            }

            #rightSidebar {
                order: 3;
            }

            .mapWrap {
                height: 60vh;
            }

            .controls {
                gap: 6px;
            }

            .btn {
                padding: 8px 11px;
            }
        }

        /* Scrollbars (WebKit) */
        .list::-webkit-scrollbar {
            width: 10px
        }

        .list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px
        }

        .list::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(124, 127, 253, .35), rgba(124, 127, 253, .25));
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.05);
        }

        .list::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(124, 127, 253, .55), rgba(124, 127, 253, .35))
        }

        /* Utility: nicer colored chips in legend */
        .legend .kv span {
            width: 10px;
            height: 10px;
            display: inline-block;
            border-radius: 3px;
            margin-right: 6px;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.18) inset, 0 1px 6px rgba(0, 0, 0, 0.25);
        }

        /* Loading states */
        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.03) 0%,
                rgba(255, 255, 255, 0.08) 50%,
                rgba(255, 255, 255, 0.03) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-title {
            height: 20px;
            width: 60%;
            margin-bottom: 12px;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(124, 127, 253, 0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Better button icons spacing */
        .btn i, .controls button i {
            margin-right: 6px;
        }

        /* Smooth page transitions */
        * {
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-duration: 0.2s;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Disable transitions on animations */
        @keyframes fadeIn, modalSlideIn, shimmer, spin {
            * { transition: none !important; }
        }
    </style>
</head>
<div id="gamesModal" style="display:none" class="modal">
    <div class="modalCard" style="max-width: 900px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>‚óÜ Club Games</h3>
            <button onclick="closeGamesModal()"
                style="background:none; border:none; color:var(--muted); cursor:pointer; font-size:18px;">√ó</button>
        </div>

        <div id="gamesFilter" style="margin-bottom: 16px;">
            <select id="gameGroupFilter" class="input" style="width: 200px; margin-bottom: 0;">
                <option value="">All games</option>
            </select>
            <label style="margin-left: 16px;">
                <input type="checkbox" id="popularOnly"> Popular only
            </label>
        </div>

        <div id="gamesGrid"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; max-height: 60vh; overflow-y: auto;">
            <!-- –ò–≥—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
</div>

<body>
    <div class="container">
        <!-- –õ–µ–≤—ã–π —Å–∞–π–¥–±–∞—Ä -->
        <aside class="sidebar" id="leftSidebar">
            <div class="card">
                <div class="small" style="margin-bottom:12px; font-weight:600; display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-award" style="color:var(--accent);"></i> My Achievements
                </div>
                <div id="achievements" class="list"></div>
            </div>

            <div class="card">
                <div class="small" style="margin-bottom:12px; font-weight:600; display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-calendar-alt" style="color:var(--booked);"></i> My Bookings
                </div>
                <div id="myBookings" class="list"></div>
            </div>
        </aside>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
        <main>
            <div class="header">
                <div class="brand">
                    <div class="h1"><i class="fas fa-map-marked-alt"></i> PC Map ‚Äî Online Booking</div>
                    <div class="small"><i class="fas fa-desktop"></i> Club hosts and their statuses</div>
                </div>
                <div class="controls">
                    <select id="groupFilter" class="input" style="width:180px; margin-bottom:0;">
                        <option value="">üè¢ All groups</option>
                    </select>
                    <button id="refresh" class="btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                    <button onclick="openLeaderboardModal()"
                        style="padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-trophy"></i> Leaderboard
                    </button>
                    <button id="gamesBtn" class="btn"><i class="fas fa-gamepad"></i> Games</button>
                    <button id="bookSelectedBtn" class="btn primary" style="display:none;">
                        <i class="fas fa-calendar-check"></i> Book selected (<span id="selectedCount">0</span>)
                    </button>
                    <button id="authBtn" class="btn primary"><i class="fas fa-user-circle"></i> Login</button>
                </div>
            </div>

            <div class="card mapWrap" id="mapCard">
                <canvas id="map"></canvas>
            </div>
        </main>

        <!-- –ü—Ä–∞–≤—ã–π —Å–∞–π–¥–±–∞—Ä -->
        <aside class="sidebar" id="rightSidebar">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div class="small" style="font-weight:600; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-chart-pie" style="color:var(--accent);"></i> Summary
                    </div>
                    <div id="userInfo" class="small" style="color:var(--muted); display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-wallet" style="font-size:11px;"></i>
                    </div>
                </div>
                <div id="summary"></div>
            </div>

            <div class="card">
                <div class="small" style="margin-bottom:12px; font-weight:600; display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-clock" style="color:var(--free);"></i> Upcoming Bookings (24h)
                </div>
                <div id="upcomingBookings" class="list"></div>
            </div>
        </aside>
    </div>—Å
    </div>

    <!-- PC Info Modal -->
    <div id="pcInfoModal" style="display:none" class="modal pc-info-modal">
        <div class="modalCard">
            <div class="pc-info-header">
                <div class="pc-status-icon" id="pcStatusIcon"></div>
                <div>
                    <h3 id="pcInfoTitle" style="margin:0"></h3>
                    <div class="small" id="pcInfoGroup"></div>
                </div>
                <button onclick="closePcInfoModal()"
                    style="margin-left:auto; background:none; border:1px solid rgba(255,255,255,0.12); border-radius:8px; padding:2px 8px; color:var(--muted); cursor:pointer; font-size:16px;">√ó</button>
            </div>

            <div id="pcCurrentStatus"></div>

            <div id="pcBookings" style="display:none">
                <div class="small" style="margin-bottom:8px">‚ñ∏ Future bookings:</div>
                <div class="booking-list" id="pcBookingsList"></div>
            </div>

            <div style="display:flex; gap:8px; margin-top:16px;">
                <button id="pcInfoBookBtn" class="btn primary" style="flex:1">‚Üí Book</button>
                <button onclick="closePcInfoModal()" class="btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginScreen" style="display:none" class="modal">
        <div class="modalCard">
            <h3>‚óè Client Login</h3>
            <div style="margin-top:12px">
                <label class="label small">‚ñ∏ Phone</label>
                <input id="loginInput" class="input" placeholder="+371..." />
            </div>
            <div style="margin-top:12px">
                <label class="label small">‚ñ∏ Password</label>
                <input id="passwordInput" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <div style="display:flex;gap:8px;margin-top:14px">
                <button id="loginSubmit" class="btn primary">‚Üí Login</button>
                <button id="loginCancel" class="btn">√ó Cancel</button>
            </div>
            <div id="loginError" style="color:#f87171;margin-top:8px"></div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" style="display:none" class="modal">
        <div class="modalCard">
            <h3 id="bookingTitle">‚ñ∏ Book a Seat</h3>
            <div id="selectedHostInfo" style="margin:10px 0;color:var(--muted)"></div>

            <div style="margin-top:10px">
                <label class="label small">‚ñ∏ Start time *</label>
                <input id="datetime" class="input" type="datetime-local" />
            </div>
            <div style="margin-top:10px">
                <label class="label small">‚ñ∏ Duration (hours)</label>
                <select id="duration" class="input">
                    <option value="1">1 hour</option>
                    <option value="2">2 hours</option>
                    <option value="3">3 hours</option>
                    <option value="4">4 hours</option>
                    <option value="6">6 hours</option>
                    <option value="8">8 hours</option>
                </select>
            </div>
            <div style="margin-top:10px">
                <label class="label small">‚ñ∏ Comment</label>
                <textarea id="comment" class="input" rows="3" placeholder="Additional requests..."></textarea>
            </div>

            <div style="display:flex;gap:8px;margin-top:14px">
                <button id="cancelBooking" class="btn">√ó Cancel</button>
                <button id="confirmBooking" class="btn primary">‚Üí Book</button>
            </div>
            <div id="formMessage" style="margin-top:8px"></div>
        </div>
    </div>
    <div id="tooltip" class="tooltip" style="display:none"></div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; padding:20px; overflow-y:auto;">
        <div style="max-width:600px; margin:40px auto; background:var(--card); border-radius:12px; padding:24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; font-size:24px;">‚òÖ Leaderboard</h2>
                <button onclick="closeLeaderboardModal()"
                    style="background:none; border:none; font-size:28px; cursor:pointer; color:var(--text);">√ó</button>
            </div>

            <div id="leaderboardMonth" class="small" style="margin-bottom:16px; color:var(--muted);"></div>

            <div id="leaderboardContent" style="display:flex; flex-direction:column; gap:8px;">
                <div style="text-align:center; padding:40px; color:var(--muted);">Loading...</div>
            </div>
        </div>
    </div>
    <script>

        let allGames = [];

        async function loadGames() {
            try {
                const res = await fetch('/api/shortcuts', { cache: 'no-store' });
                const games = await res.json();

                if (!Array.isArray(games)) {
                    console.error('Games is not an array:', games);
                    allGames = [];
                    return;
                }

                allGames = games;
                populateGameGroups();
                renderGames(games);
            } catch (err) {
                console.error('Failed to load games:', err);
                allGames = [];
            }
        }

        function populateGameGroups() {
            if (!Array.isArray(allGames)) {
                console.error('allGames is not an array');
                return;
            }

            const select = document.getElementById('gameGroupFilter');
            const groups = [...new Set(allGames.map(g => g.group?.title).filter(Boolean))];

            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                select.appendChild(option);
            });
        }

        function filterGames() {
            const groupFilter = document.getElementById('gameGroupFilter').value;
            const popularOnly = document.getElementById('popularOnly').checked;

            let filtered = allGames;

            if (groupFilter) {
                filtered = filtered.filter(g => g.group?.title === groupFilter);
            }

            if (popularOnly) {
                filtered = filtered.filter(g => g.popular);
            }

            renderGames(filtered);
        }





        function renderGames(games) {
            const grid = document.getElementById('gamesGrid');

            // Filter only games, remove APPLICATION
            const gamesOnly = games.filter(game => game.type !== 'APPLICATION');

            if (!gamesOnly || gamesOnly.length === 0) {
                grid.innerHTML = '<div style="color:var(--muted); text-align: center; grid-column: 1/-1;">No games found</div>';
                return;
            }

            grid.innerHTML = gamesOnly.map(game => {
                const ageRating = game.age_rating ? `${game.age_rating}+` : '';
                const popular = game.popular ? '‚≠ê ' : '';
                const freeRun = game.free_run ? 'üÜì ' : '';

                let iconHtml;
                if (game.icon_path) {
                    iconHtml = `<img src="${game.icon_path}" style="width: 48px; height: 48px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                       <div style="font-size: 28px; display: none;">‚óÜ</div>`;
                } else if (game.main_picture) {
                    iconHtml = `<img src="${game.main_picture}" style="width: 48px; height: 48px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                       <div style="font-size: 28px; display: none;">‚óÜ</div>`;
                } else {
                    iconHtml = `<div style="font-size: 28px;">‚óÜ</div>`;
                }

                return `
            <div class="card" style="padding: 16px; display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    ${iconHtml}
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 4px;">${popular ? '‚òÖ ' : ''}${game.title || 'No title'}</div>
                        <div class="small">${game.group?.title || 'No group'}</div>
                    </div>
                </div>

                <div style="margin-top: auto; display: flex; justify-content: space-between; align-items: center;">
                    <div class="small">
                        ${ageRating ? `<span style="background: var(--warning); color: black; padding: 2px 6px; border-radius: 4px; font-size: 10px;">${ageRating}</span>` : ''}
                        ${freeRun ? '<span style="color: var(--success);">Free</span>' : ''}
                    </div>
                    <div class="small" style="color: var(--muted);">${game.type || ''}</div>
                </div>
            </div>
        `;
            }).join('');
        }

        function openGamesModal() {
            document.getElementById('gamesModal').style.display = 'flex';
            if (allGames.length === 0) {
                loadGames();
            }
        }

        function closeGamesModal() {
            document.getElementById('gamesModal').style.display = 'none';
        }

        // Event listeners
        document.getElementById('gamesBtn').addEventListener('click', openGamesModal);
        document.getElementById('gameGroupFilter').addEventListener('change', filterGames);
        document.getElementById('popularOnly').addEventListener('change', filterGames);

        // --- Client-side JS (modern, responsive) ---
        const canvas = document.getElementById('map');
        const ctx = canvas.getContext('2d');
        const state = {
            hosts: [],
            bookings: [],
            scale: 48,
            padding: 36,
            offsetX: 0,
            offsetY: 0,
            selectedGroup: '',
            hoveredHost: null,
            selectedHost: null,
            selectedHosts: new Set()
        };

        function resizeCanvas() {
            const r = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = Math.floor(r.width * dpr);
            canvas.height = Math.floor(r.height * dpr);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        function colorFor(h) {
            if (h.session) return getComputedStyle(document.documentElement).getPropertyValue('--busy') || '#3b82f6';
            const hasBooking = state.bookings.some(b => b.hosts.some(bh => bh.id == h.id));
            if (hasBooking) return getComputedStyle(document.documentElement).getPropertyValue('--booked') || '#f59e0b';
            return getComputedStyle(document.documentElement).getPropertyValue('--free') || '#10b981';
        }

        function getStatusEmoji(h) {
            if (h.session) return '‚óè';
            const hasBooking = state.bookings.some(b => b.hosts.some(bh => bh.id == h.id));
            if (hasBooking) return '‚óÜ';
            return '‚óã';
        }

        async function loadBookings() {
            try {
                const res = await fetch('/api/bookings', { cache: 'no-store' });
                state.bookings = await res.json();
                renderUpcomingBookings(state.bookings);
                draw();
            } catch (err) { console.error('Failed to load bookings:', err) }
        }

        function renderUpcomingBookings(bookings) {
            const el = document.getElementById('upcomingBookings');
            if (!bookings || bookings.length === 0) {
                el.innerHTML = '<div class="small" style="color:var(--muted);padding:8px">No upcoming bookings</div>';
                return;
            }

            el.innerHTML = bookings.map(b => {
                const fromDate = new Date(b.from);
                const toDate = new Date(b.to);
                const dateStr = fromDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                const fromTime = fromDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                const toTime = toDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                const hostNames = b.hosts.map(h => h.alias || `PC ${h.id}`).join(', ');
                const clientName = b.client?.nickname || b.client?.phone || 'Guest';

                return `<div class="item">
                    <div>
                        <div style="font-weight:600">‚ñ∏ ${hostNames}</div>
                        <div class="small">${clientName}</div>
                    </div>
                    <div style="text-align:right">
                        <div class="small" style="color:var(--muted);margin-bottom:2px">${dateStr}</div>
                        <div style="font-size:13px;color:var(--booked)">${fromTime} - ${toTime}</div>
                        <div class="small">${b.status}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function computeBounds(hosts) {
            const withCoords = hosts.filter(h => Number.isFinite(h.coord_x) && Number.isFinite(h.coord_y));
            if (!withCoords.length) return { minX: 0, minY: 0, maxX: 1, maxY: 1 };
            const xs = withCoords.map(h => h.coord_x);
            const ys = withCoords.map(h => h.coord_y);
            return { minX: Math.min(...xs), minY: Math.min(...ys), maxX: Math.max(...xs), maxY: Math.max(...ys) }
        }

        function fitToView() {
            const pad = state.padding;
            const r = canvas.getBoundingClientRect();
            const b = computeBounds(filtered(state.hosts));
            const widthCells = (b.maxX - b.minX + 1) || 1;
            const heightCells = (b.maxY - b.minY + 1) || 1;
            const sx = (r.width - pad * 2) / widthCells;
            const sy = (r.height - pad * 2) / heightCells;
            state.scale = Math.max(28, Math.floor(Math.min(sx, sy)));
            const gridW = widthCells * state.scale;
            const gridH = heightCells * state.scale;
            state.offsetX = pad + Math.floor((r.width - pad * 2 - gridW) / 2);
            state.offsetY = pad + Math.floor((r.height - pad * 2 - gridH) / 2);
        }

        function filtered(hosts) {
            if (!state.selectedGroup) return hosts;
            return hosts.filter(h => h.group?.id === state.selectedGroup)
        }

        function draw() {
            resizeCanvas();
            const hosts = filtered(state.hosts);
            const r = canvas.getBoundingClientRect();
            ctx.clearRect(0, 0, r.width, r.height);
            ctx.fillStyle = '#07121b';
            ctx.fillRect(0, 0, r.width, r.height);
            if (!draw._fittedOnce) { fitToView(); draw._fittedOnce = true }

            const b = computeBounds(hosts);
            ctx.strokeStyle = 'rgba(255,255,255,0.03)';
            ctx.lineWidth = 1;

            for (let x = b.minX; x <= b.maxX + 1; x++) {
                const px = state.offsetX + (x - b.minX) * state.scale;
                ctx.beginPath(); ctx.moveTo(px, state.offsetY); ctx.lineTo(px, r.height - state.offsetY); ctx.stroke()
            }
            for (let y = b.minY; y <= b.maxY + 1; y++) {
                const py = state.offsetY + (y - b.minY) * state.scale;
                ctx.beginPath(); ctx.moveTo(state.offsetX, py); ctx.lineTo(r.width - state.offsetX, py); ctx.stroke()
            }

            ctx.textBaseline = 'middle';
            ctx.font = '12px Inter, system-ui';

            for (const h of hosts) {
                if (!Number.isFinite(h.coord_x) || !Number.isFinite(h.coord_y)) continue;
                const gx = (h.coord_x - b.minX), gy = (h.coord_y - b.minY);
                const cx = state.offsetX + gx * state.scale + state.scale / 2;
                const cy = state.offsetY + gy * state.scale + state.scale / 2;
                const w = Math.max(state.scale - 8, 36);
                const hgt = Math.max(state.scale - 8, 38);
                const x = cx - w / 2, y = cy - hgt / 2;
                const isHovered = state.hoveredHost && state.hoveredHost.id === h.id;
                const isSelected = state.selectedHosts.has(h.id);

                // Fill
                ctx.fillStyle = colorFor(h);
                if (isHovered) ctx.globalAlpha = 0.85;
                roundRect(ctx, x, y, w, hgt, 8);
                ctx.fill();
                ctx.globalAlpha = 1;

                // –†–∞–º–∫–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ü–ö
                if (isSelected) {
                    ctx.strokeStyle = '#00bcd4';
                    ctx.lineWidth = 3;
                    roundRect(ctx, x, y, w, hgt, 8);
                    ctx.stroke();
                }

                // Emoji status
                const emoji = getStatusEmoji(h);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#ffffff';
                const emojiWidth = ctx.measureText(emoji).width;
                ctx.fillText(emoji, cx - emojiWidth / 2, cy - 8);

                // Label
                ctx.font = '11px Inter, system-ui';
                ctx.fillStyle = '#061226';
                const label = h.alias ?? '‚Äî';
                clipText(ctx, label, x + 8, cy + 8, w - 16);

                // Session info
                if (h.session) {
                    ctx.fillStyle = 'rgba(184,195,211,0.9)';
                    let timeText = '';
                    if (h.session.time_left && h.session.time_left > 0) {
                        const endTime = new Date(Date.now() + h.session.time_left * 1000);
                        timeText = '–¥–æ ' + endTime.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    } else if (h.session.started_at && h.session.duration) {
                        const start = new Date(h.session.started_at);
                        const end = new Date(start.getTime() + h.session.duration * 1000);
                        timeText = '–¥–æ ' + end.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    }
                    if (timeText) clipText(ctx, timeText, x + 8, cy + 18, w - 16);
                }
            }
        }

        function roundRect(ctx, x, y, w, h, r) {
            const rr = Math.min(r, w / 2, h / 2);
            ctx.beginPath();
            ctx.moveTo(x + rr, y);
            ctx.arcTo(x + w, y, x + w, y + h, rr);
            ctx.arcTo(x + w, y + h, x, y + h, rr);
            ctx.arcTo(x, y + h, x, y, rr);
            ctx.arcTo(x, y, x + w, y, rr);
            ctx.closePath();
        }

        function clipText(ctx, text, x, midY, maxW) {
            let t = String(text ?? "");
            while (ctx.measureText(t).width > maxW && t.length > 1) t = t.slice(0, -1);
            if (t !== text && maxW > 10) t = t.slice(0, -1) + '‚Ä¶';
            ctx.fillText(t, x, midY)
        }

        function getHostAtPosition(x, y) {
            const hosts = filtered(state.hosts);
            const b = computeBounds(hosts);
            for (const h of hosts) {
                if (!Number.isFinite(h.coord_x) || !Number.isFinite(h.coord_y)) continue;
                const gx = (h.coord_x - b.minX), gy = (h.coord_y - b.minY);
                const cx = state.offsetX + gx * state.scale + state.scale / 2;
                const cy = state.offsetY + gy * state.scale + state.scale / 2;
                const w = Math.max(state.scale - 8, 36);
                const hgt = Math.max(state.scale - 8, 38);
                const hx = cx - w / 2;
                const hy = cy - hgt / 2;
                if (x >= hx && x <= hx + w && y >= hy && y <= hy + hgt) return h
            }
            return null
        }

        function openPcInfoModal(host) {
            state.selectedHost = host;
            const modal = document.getElementById('pcInfoModal');
            const icon = document.getElementById('pcStatusIcon');
            const title = document.getElementById('pcInfoTitle');
            const group = document.getElementById('pcInfoGroup');
            const status = document.getElementById('pcCurrentStatus');
            const bookingsDiv = document.getElementById('pcBookings');
            const bookingsList = document.getElementById('pcBookingsList');
            const bookBtn = document.getElementById('pcInfoBookBtn');

            title.textContent = host.alias || `PC ${host.id}`;
            group.textContent = host.group?.title || 'No group';

            if (host.session) {
                icon.textContent = '‚óè';
                icon.className = 'pc-status-icon busy';
                status.innerHTML = `<div style="color:var(--busy); font-weight:600;">‚óè In Use</div>
                    <div class="small">User: ${host.session.user || 'Unknown'}</div>`;
                bookBtn.disabled = true;
                bookBtn.textContent = 'In Use';
            } else {
                const hasBooking = state.bookings.some(b => b.hosts.some(bh => bh.id == host.id));
                if (hasBooking) {
                    icon.textContent = '‚óÜ';
                    icon.className = 'pc-status-icon booked';
                    status.innerHTML = `<div style="color:var(--booked); font-weight:600;">‚óÜ Booked</div>`;
                } else {
                    icon.textContent = '‚óã';
                    icon.className = 'pc-status-icon free';
                    status.innerHTML = `<div style="color:var(--free); font-weight:600;">‚óã Available</div>`;
                }
                bookBtn.disabled = false;
                bookBtn.textContent = '‚Üí Book';
            }

            const hostBookings = state.bookings.filter(b =>
                b.hosts.some(bh => bh.id == host.id)
            );

            if (hostBookings.length > 0) {
                bookingsDiv.style.display = 'block';
                bookingsList.innerHTML = hostBookings.map(b => {
                    const fromTime = new Date(b.from).toLocaleString('ru-RU', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const toTime = new Date(b.to).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    const client = b.client?.nickname || b.client?.phone || 'Guest';
                    return `
                        <div class="booking-item">
                            <div>
                                <div class="booking-time">${fromTime} - ${toTime}</div>
                                <div class="booking-client">${client}</div>
                            </div>
                            <div class="small" style="color:var(--booked)">${b.status}</div>
                        </div>`;
                }).join('');
            } else {
                bookingsDiv.style.display = 'none';
            }
            modal.style.display = 'flex';
        }
        function closePcInfoModal() {
            document.getElementById('pcInfoModal').style.display = 'none';
            state.selectedHost = null;
        }

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const host = getHostAtPosition(x, y);
            const tooltip = document.getElementById('tooltip');

            if (host) {
                state.hoveredHost = host;
                canvas.style.cursor = 'pointer';

                let tooltipText = `${getStatusEmoji(host)} ${host.alias ?? 'Seat ' + host.id}`;
                if (host.group?.title) tooltipText += ` ‚Ä¢ ${host.group.title}`;

                const booking = state.bookings.find(b => b.hosts.some(bh => bh.id == host.id));
                if (booking) {
                    const fromDate = new Date(booking.from);
                    const dateStr = fromDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                    const fromTime = fromDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    tooltipText += `<br>‚óÜ Booking: ${dateStr}, ${fromTime}`;
                    if (booking.client?.nickname) tooltipText += ` (${booking.client.nickname})`;
                }

                if (host.session) {
                    tooltipText += host.session.user
                        ? `<br>‚óè Playing: ${host.session.user}`
                        : `<br>‚óè In Use`;

                    let timeLeft = null;
                    if (host.session.time_left && host.session.time_left > 0) {
                        timeLeft = host.session.time_left;
                    } else if (host.session.started_at && host.session.duration) {
                        const start = new Date(host.session.started_at);
                        const end = new Date(start.getTime() + host.session.duration * 1000);
                        timeLeft = Math.max(0, Math.floor((end.getTime() - Date.now()) / 1000));
                    }

                    if (timeLeft && timeLeft > 0) {
                        const hours = Math.floor(timeLeft / 3600);
                        const minutes = Math.floor((timeLeft % 3600) / 60);
                        tooltipText += hours > 0
                            ? `<br>‚ñ∏ Remaining: ${hours}h ${minutes}m`
                            : `<br>‚ñ∏ Remaining: ${minutes}m`;
                    }
                }

                tooltip.innerHTML = tooltipText;
                tooltip.style.display = 'block';

                // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –î–û requestAnimationFrame
                const mouseX = e.clientX;
                const mouseY = e.clientY;

                requestAnimationFrame(() => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    const offset = 20;

                    let tooltipX = mouseX + offset;
                    let tooltipY = mouseY + offset;

                    if (tooltipX + tooltipRect.width > window.innerWidth - 10) {
                        tooltipX = mouseX - tooltipRect.width - offset;
                    }

                    if (tooltipY + tooltipRect.height > window.innerHeight - 10) {
                        tooltipY = mouseY - tooltipRect.height - offset;
                    }

                    tooltip.style.left = tooltipX + 'px';
                    tooltip.style.top = tooltipY + 'px';
                });

                draw();
            } else {
                state.hoveredHost = null;
                canvas.style.cursor = 'default';
                tooltip.style.display = 'none';
                draw();
            }
        });

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const host = getHostAtPosition(x, y);
            if (host) {
                if (e.ctrlKey || e.metaKey) {
                    // Ctrl/Cmd + –∫–ª–∏–∫ = –¥–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å –∏–∑ –≤—ã–±–æ—Ä–∞
                    if (state.selectedHosts.has(host.id)) {
                        state.selectedHosts.delete(host.id);
                    } else {
                        state.selectedHosts.add(host.id);
                    }
                    updateSelectedCount();
                    draw();
                } else {
                    // –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫ = –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
                    openPcInfoModal(host);
                }
            }


        });

        function updateSelectedCount() {
            const count = state.selectedHosts.size;
            const btn = document.getElementById('bookSelectedBtn');
            const countEl = document.getElementById('selectedCount');

            if (count > 0) {
                btn.style.display = 'block';
                countEl.textContent = count;
            } else {
                btn.style.display = 'none';
            }
        }

        document.getElementById('pcInfoBookBtn').addEventListener('click', () => {
            if (state.selectedHost) {
                const hostToBook = state.selectedHost;
                closePcInfoModal();
                if (!isLoggedIn()) {
                    alert('You need to login to book');
                    document.getElementById('loginScreen').style.display = 'flex';
                    return;
                }
                openBookingModal(hostToBook);
            }
        });

        document.getElementById('bookSelectedBtn').addEventListener('click', () => {
            if (state.selectedHosts.size === 0) return;

            if (!isLoggedIn()) {
                alert('–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏');
                document.getElementById('loginScreen').style.display = 'flex';
                return;
            }

            openBookingModalMultiple(Array.from(state.selectedHosts));
        });

        function openBookingModalMultiple(hostIds) {
            const hostNames = hostIds.map(id => {
                const host = state.hosts.find(h => h.id === id);
                return host?.alias || `–ü–ö ${id}`;
            }).join(', ');

            document.getElementById('bookingTitle').textContent = `üìÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–∞ (${hostIds.length})`;
            document.getElementById('selectedHostInfo').textContent = hostNames;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            state.bookingHostIds = hostIds;

            const now = new Date();
            const rigaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/Riga' }));
            rigaTime.setMinutes(rigaTime.getMinutes() + 30);
            const year = rigaTime.getFullYear();
            const month = String(rigaTime.getMonth() + 1).padStart(2, '0');
            const day = String(rigaTime.getDate()).padStart(2, '0');
            const hours = String(rigaTime.getHours()).padStart(2, '0');
            const minutes = String(rigaTime.getMinutes()).padStart(2, '0');
            const min = `${year}-${month}-${day}T${hours}:${minutes}`;
            const dt = document.getElementById('datetime');
            dt.min = min;
            dt.value = min;
            document.getElementById('bookingModal').style.display = 'flex';
        }

        window.addEventListener('resize', () => { draw._fittedOnce = false; draw(); });

        async function loadHosts() {
            try {
                const res = await fetch('/api/hosts', { cache: 'no-store' });
                const hosts = await res.json();
                state.hosts = hosts;
                renderSummary(hosts);
                ensureGroups(hosts);
                draw();
            } catch (err) { console.error(err) }
        }

        function renderSummary(hosts) {
            const busy = hosts.filter(h => h.session !== null).length;
            const booked = state.bookings ? state.bookings.length : 0;
            const free = hosts.length - busy;
            const total = hosts.length;
            const freePercent = Math.round((free / total) * 100);
            const busyPercent = Math.round((busy / total) * 100);

            document.getElementById('summary').innerHTML =
                `<div style="display:flex;gap:10px;align-items:center;padding:10px 0;">
                    <i class="fas fa-circle" style="color:var(--free);font-size:10px;"></i>
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <span style="font-size:12px;">Available</span>
                            <strong style="color:var(--free);">${free}</strong>
                        </div>
                        <div style="background:rgba(16,185,129,0.1);height:6px;border-radius:3px;overflow:hidden;">
                            <div style="background:var(--free);height:100%;width:${freePercent}%;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:10px;align-items:center;padding:10px 0;">
                    <i class="fas fa-circle" style="color:var(--busy);font-size:10px;"></i>
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <span style="font-size:12px;">In Use</span>
                            <strong style="color:var(--busy);">${busy}</strong>
                        </div>
                        <div style="background:rgba(59,130,246,0.1);height:6px;border-radius:3px;overflow:hidden;">
                            <div style="background:var(--busy);height:100%;width:${busyPercent}%;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:10px;align-items:center;padding:10px 0;">
                    <i class="fas fa-circle" style="color:var(--booked);font-size:10px;"></i>
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <span style="font-size:12px;">Booked (24h)</span>
                            <strong style="color:var(--booked);">${booked}</strong>
                        </div>
                    </div>
                </div>`;
        }

        async function loadMyBookings() {
            const container = document.getElementById('myBookings');

            if (!isLoggedIn()) {
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px;display:flex;align-items:center;gap:8px;"><i class="fas fa-lock"></i> Login to view bookings</div>';
                return;
            }

            // Show loading
            container.innerHTML = `
                <div class="item">
                    <div style="flex:1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width:50%;"></div>
                    </div>
                </div>
            `;

            try {
                const user = JSON.parse(localStorage.getItem('user'));
                const allBookings = await fetch('/api/bookings', { cache: 'no-store' }).then(r => r.json());

                const myBookings = allBookings.filter(b =>
                    b.client?.id === user.id &&
                    (b.status === 'PENDING' || b.status === 'ACTIVE')
                );

                if (myBookings.length === 0) {
                    container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px;display:flex;align-items:center;gap:8px;"><i class="fas fa-inbox"></i> No active bookings</div>';
                    return;
                }

                container.innerHTML = myBookings.map(b => {
                    const fromDate = new Date(b.from);
                    const toDate = new Date(b.to);
                    const dateStr = fromDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                    const fromTime = fromDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const toTime = toDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const hostNames = b.hosts.map(h => h.alias || `PC ${h.id}`).join(', ');

                    return `
                <div class="item" style="display:block; padding:12px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <div style="font-weight:600; display:flex; align-items:center; gap:6px;">
                            <i class="fas fa-desktop" style="color:var(--accent);font-size:12px;"></i> ${hostNames}
                        </div>
                        <button onclick="cancelBooking(${b.id})"
                                style="background:none; border:1px solid rgba(248,113,113,0.5); color:#f87171; padding:4px 10px; border-radius:6px; cursor:pointer; font-size:11px; transition:all 0.2s;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                    <div class="small" style="color:var(--muted); display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-clock" style="font-size:10px;"></i> ${dateStr} ‚Ä¢ ${fromTime} - ${toTime}
                    </div>
                    <div class="small" style="color:var(--booked); margin-top:4px; display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-info-circle" style="font-size:10px;"></i> ${b.status}
                    </div>
                </div>
            `;
                }).join('');
            } catch (err) {
                console.error('Failed to load my bookings:', err);
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px">Loading error</div>';
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Cancel this booking?')) return;

            try {
                const res = await fetch(`/api/bookings/${bookingId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('sessionId'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ bookingId })
                });

                const json = await res.json();

                if (!res.ok) throw new Error(json.error || 'Cancel error');

                alert('‚Üí Booking cancelled');
                loadBookings();
                loadMyBookings();
                loadHosts();
            } catch (err) {
                alert('√ó ' + err.message);
            }
        }

        async function loadAchievements() {
            const container = document.getElementById('achievements');

            if (!isLoggedIn()) {
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px;display:flex;align-items:center;gap:8px;"><i class="fas fa-lock"></i> Login to view achievements</div>';
                return;
            }

            // Show loading skeleton
            container.innerHTML = `
                <div class="item">
                    <div style="flex:1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width:40%;"></div>
                    </div>
                </div>
                <div class="item">
                    <div style="flex:1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width:40%;"></div>
                    </div>
                </div>
            `;

            try {
                const res = await fetch('/api/achievements', {
                    cache: 'no-store',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('sessionId')
                    }
                });
                const achievements = await res.json();

                if (!achievements || achievements.length === 0) {
                    container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px">No achievements</div>';
                    return;
                }

                container.innerHTML = achievements.map(ach => {
                    const condition = ach.conditions?.[0];
                    const reward = ach.rewards?.[0];

                    if (!condition) return '';

                    // Define achievement type and format progress
                    let currentValue = 0;
                    let targetValue = condition.value;
                    let unit = '';
                    let icon = '‚óÜ';

                    if (condition.name === 'spent_hours') {
                        // Convert seconds to hours
                        currentValue = Math.floor((ach.progress / 100) * (targetValue / 3600));
                        targetValue = Math.floor(targetValue / 3600);
                        unit = ' h';
                        icon = '‚ñ∏';
                    } else if (condition.name === 'add_deposit_overall') {
                        currentValue = Math.floor((ach.progress / 100) * targetValue);
                        unit = '‚Ç¨';
                        icon = '‚óè';
                    } else if (condition.name === 'register') {
                        currentValue = ach.progress;
                        targetValue = 1;
                        icon = '‚óã';
                    } else {
                        currentValue = Math.floor((ach.progress / 100) * targetValue);
                    }

                    const percentage = Math.min(100, Math.floor(ach.progress));
                    const isCompleted = ach.has || percentage >= 100;

                    // Format reward
                    let rewardText = '';
                    if (reward) {
                        if (reward.name === 'add_deposit') {
                            rewardText = `<div class="small" style="color: var(--accent); margin-top: 4px;">‚Üí Reward: ${reward.value}‚Ç¨</div>`;
                        }
                    }

                    return `
                <div class="item" style="display: block; padding: 12px; ${isCompleted ? 'background: rgba(76, 175, 80, 0.1);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${ach.icon_url ? `<img src="${ach.icon_url}" style="width: 24px; height: 24px; object-fit: contain;" />` : icon}
                            <div style="font-weight: 500;">${isCompleted ? '‚úì' : ''} ${ach.name || 'Achievement'}</div>
                        </div>
                        <div class="small" style="font-weight: 600;">${currentValue}${unit} / ${targetValue}${unit}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 4px;">
                        <div style="background: ${isCompleted ? '#4CAF50' : 'var(--accent)'}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                    </div>
                    ${rewardText}
                </div>
            `;
                }).filter(Boolean).join('');

            } catch (err) {
                console.error('Failed to load achievements:', err);
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px">Loading error</div>';
            }
        }

        function ensureGroups(hosts) {
            const sel = document.getElementById('groupFilter');
            const exists = new Set(Array.from(sel.options).map(o => o.value));

            hosts.forEach(h => {
                if (h.group?.id && !exists.has(h.group.id)) {
                    const op = document.createElement('option');
                    op.value = h.group.id;
                    op.textContent = h.group.title || h.group.id;
                    sel.appendChild(op);
                    exists.add(h.group.id);
                }
            });
        }

        document.getElementById('groupFilter').addEventListener('change', (e) => {
            state.selectedGroup = e.target.value;
            draw._fittedOnce = false;
            draw();
        });

        document.getElementById('refresh').addEventListener('click', (e) => {
            const icon = e.currentTarget.querySelector('i');
            if (icon) {
                icon.style.animation = 'spin 0.8s linear';
                setTimeout(() => { icon.style.animation = ''; }, 800);
            }
            loadHosts();
            loadBookings();
        });

        function openBookingModal(host) {
            state.selectedHost = host;
            document.getElementById('bookingTitle').textContent = `‚ñ∏ ${host.alias || ('Seat ' + host.id)}`;
            document.getElementById('selectedHostInfo').textContent = host.group && host.group.title ? host.group.title : '';
            const now = new Date();
            const rigaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/Riga' }));
            rigaTime.setMinutes(rigaTime.getMinutes() + 30);
            const year = rigaTime.getFullYear();
            const month = String(rigaTime.getMonth() + 1).padStart(2, '0');
            const day = String(rigaTime.getDate()).padStart(2, '0');
            const hours = String(rigaTime.getHours()).padStart(2, '0');
            const minutes = String(rigaTime.getMinutes()).padStart(2, '0');
            const min = `${year}-${month}-${day}T${hours}:${minutes}`;
            const dt = document.getElementById('datetime');
            dt.min = min; dt.value = min;
            document.getElementById('bookingModal').style.display = 'flex';
        }
        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
            document.getElementById('formMessage').innerHTML = '';
            state.selectedHost = null;
        }
        document.getElementById('cancelBooking').addEventListener('click', closeBookingModal);

        function isLoggedIn() {
            const sessionId = localStorage.getItem('sessionId');
            const user = localStorage.getItem('user');
            return !!(sessionId && user);
        }

        document.getElementById('confirmBooking').addEventListener('click', async () => {
            if (!isLoggedIn()) {
                alert('Session expired. Please login again.');
                document.getElementById('bookingModal').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                return;
            }
            const datetime = document.getElementById('datetime').value;
            const durationHours = Number(document.getElementById('duration').value);
            const comment = document.getElementById('comment').value.trim();
            const msg = document.getElementById('formMessage'); msg.innerHTML = '';
            if (!datetime) {
                msg.innerHTML = '<div style="color:#f87171">√ó Select time</div>';
                return;
            }
            const fromIso = new Date(datetime).toISOString();
            const sessionId = localStorage.getItem('sessionId');
            const user = JSON.parse(localStorage.getItem('user'));
            try {
                const res = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionId
                    },
                    body: JSON.stringify({
                        phone: user.phone || user.login,
                        from: fromIso,
                        duration: durationHours * 3600,
                        hostIds: state.bookingHostIds || [state.selectedHost.id],
                        comment
                    })
                });
                const json = await res.json();
                if (!res.ok) {
                    if (res.status === 401) {
                        alert('Session expired. Please login again.');
                        localStorage.removeItem('sessionId');
                        localStorage.removeItem('user');
                        document.getElementById('bookingModal').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                        return;
                    }
                    throw new Error(json.error || 'Error');
                }
                msg.innerHTML = '<div style="color:#34d399">‚Üí Booking created. ID: ' + json.id + '</div>';
                setTimeout(() => {
                    closeBookingModal();
                    loadHosts();
                    loadBookings();
                }, 1200);
            } catch (err) {
                msg.innerHTML = '<div style="color:#f87171">√ó ' + err.message + '</div>';
            }
        });

        // Logout function
        function logout() {
            localStorage.clear();
            document.getElementById('userInfo').innerHTML = '';
            document.getElementById('authBtn').innerHTML = '<i class="fas fa-user-circle"></i> Login';
            document.getElementById('achievements').innerHTML = '<div class="small" style="color:var(--muted);padding:8px;display:flex;align-items:center;gap:8px;"><i class="fas fa-lock"></i> Login to view achievements</div>';
            document.getElementById('myBookings').innerHTML = '<div class="small" style="color:var(--muted);padding:8px;display:flex;align-items:center;gap:8px;"><i class="fas fa-lock"></i> Login to view bookings</div>';
        }
        // async function loadPayments() {
        //     const container = document.getElementById('payments');

        //     if (!isLoggedIn()) {
        //         container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</div>';
        //         return;
        //     }

        //     try {
        //         const res = await fetch('/api/payments', {
        //             cache: 'no-store',
        //             headers: {
        //                 'Authorization': 'Bearer ' + localStorage.getItem('sessionId')
        //             }
        //         });
        //         const data = await res.json();

        //         container.innerHTML = `
        //     <div class="item" style="display: flex; justify-content: space-between; align-items: center;">
        //         <div>
        //             <div style="font-weight: 500; margin-bottom: 4px;">–í—Å–µ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π</div>
        //             <div class="small" style="color: var(--muted);">${data.count} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
        //         </div>
        //         <div style="text-align: right;">
        //             <div style="font-size: 20px; font-weight: 600; color: var(--accent);">${data.total}‚Ç¨</div>
        //             ${data.totalBonus > 0 ? `<div class="small" style="color: var(--free);">+${data.totalBonus}‚Ç¨ –±–æ–Ω—É—Å–æ–≤</div>` : ''}
        //         </div>
        //     </div>
        // `;

        //     } catch (err) {
        //         console.error('Failed to load payments:', err);
        //         container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        //     }
        // }
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        document.getElementById('authBtn').addEventListener('click', () => {
            if (isLoggedIn()) {
                logout();
            } else {
                document.getElementById('loginInput').value = '';
                document.getElementById('passwordInput').value = '';
                document.getElementById('loginError').textContent = '';
                document.getElementById('loginScreen').style.display = 'flex';
            }
        });

        document.getElementById('loginCancel').addEventListener('click', () => {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('loginError').textContent = '';
        });

        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        async function openLeaderboardModal() {
            const modal = document.getElementById('leaderboardModal');
            const content = document.getElementById('leaderboardContent');
            const monthEl = document.getElementById('leaderboardMonth');

            modal.style.display = 'block';
            content.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted);">Loading...</div>';

            try {
                const res = await fetch('/api/leaderboard', { cache: 'no-store' });
                const data = await res.json();

                monthEl.textContent = `${MONTH_NAMES[data.month - 1]} ${data.year}`;

                if (!data.leaders || data.leaders.length === 0) {
                    content.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted);">No data yet</div>';
                    return;
                }

                content.innerHTML = data.leaders.map((leader, index) => {
                    const position = index + 1;
                    const isTop3 = position <= 3;
                    const medal = position === 1 ? '‚óè' : position === 2 ? '‚óÜ' : position === 3 ? '‚óã' : '';
                    const hours = (leader.totalTime / 3600).toFixed(1);

                    return `
                <div class="item" style="display: flex; align-items: center; gap: 16px; padding: 12px; ${isTop3 ? 'background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3);' : ''}">
                    <div style="font-size: 24px; font-weight: 600; min-width: 40px; text-align: center;">
                        ${medal ? `<span style="color: var(--accent);">${medal}</span>` : position}
                    </div>
                    ${leader.avatarUrl ?
                            `<img src="${leader.avatarUrl}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;" />` :
                            `<div style="width: 48px; height: 48px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600;">${(leader.nickname || leader.name)?.charAt(0) || '?'}</div>`
                        }
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${leader.nickname || leader.name || 'Player'}</div>
                        <div class="small" style="color: var(--muted);">ID: ${leader.userId}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: 600; color: var(--accent);">${hours}h</div>
                        <div class="small" style="color: var(--muted);">total</div>
                    </div>
                </div>
            `;
                }).join('');

            } catch (err) {
                console.error('Failed to load leaderboard:', err);
                content.innerHTML = '<div style="text-align:center; padding:40px; color:var(--error);">Loading error</div>';
            }
        }

        function closeLeaderboardModal() {
            document.getElementById('leaderboardModal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('leaderboardModal');
            if (e.target === modal) {
                closeLeaderboardModal();
            }
        });

        async function handleLogin() {
            const loginInput = document.getElementById('loginInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorEl = document.getElementById('loginError');

            errorEl.textContent = '';

            if (!loginInput || !password) {
                errorEl.textContent = 'Fill all fields';
                return;
            }

            try {
                const r = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login: loginInput, password })
                });
                const data = await r.json();
                if (r.ok && data.success) {
                    localStorage.clear();
                    localStorage.setItem('sessionId', data.sessionId);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    const user = data.user;
                    if (user) {
                        const balance = ((user.deposit || 0) + (user.bonus || 0)).toFixed(2);
                        document.getElementById('userInfo').innerHTML = `<i class="fas fa-user"></i> ${user.nickname || ''} ‚Ä¢ <i class="fas fa-wallet" style="font-size:11px;"></i> ${balance}‚Ç¨`;
                    }

                    document.getElementById('authBtn').innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
                    document.getElementById('loginScreen').style.display = 'none';
                    loadAchievements();
                    loadMyBookings();
                } else {
                    errorEl.textContent = data.error || 'Invalid login/password';
                }
            } catch (err) {
                errorEl.textContent = 'Network error';
            }
        }

        document.getElementById('loginSubmit').addEventListener('click', handleLogin);

        // Enter key support
        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        // Restore session
        function restoreSession() {
            const user = localStorage.getItem('user');
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    if (userData) {
                        const balance = ((userData.deposit || 0) + (userData.bonus || 0)).toFixed(2);
                        document.getElementById('userInfo').innerHTML = `<i class="fas fa-user"></i> ${userData.nickname || ''} ‚Ä¢ <i class="fas fa-wallet" style="font-size:11px;"></i> ${balance}‚Ç¨`;
                        document.getElementById('authBtn').innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
                        loadAchievements();
                        loadMyBookings();
                    }
                } catch (e) { console.error('Session restore error', e); }
            } else {
                loadAchievements();
                loadMyBookings();
            }
        }

        restoreSession();
        loadHosts();
        loadBookings();
        setInterval(() => {
            loadHosts();
            loadBookings();
        }, 30000);
        window.addEventListener('resize', () => { draw._fittedOnce = false; draw() });
    </script>
</body>

</html>