<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes" />
    <meta name="theme-color" content="#0a0f1a" />
    <title>Cyberbook ‚Äî PC Gaming Club</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Premium Theme */
        :root {
            --bg: #050a12;
            --bg-2: #0a0f1a;
            --bg-3: #0f1520;
            --card: linear-gradient(145deg, rgba(17, 24, 39, 0.95), rgba(15, 23, 42, 0.9));
            --card-hover: linear-gradient(145deg, rgba(20, 28, 45, 0.98), rgba(17, 25, 44, 0.95));
            --muted: #94a3b8;
            --text: #f1f5f9;
            --text-bright: #ffffff;
            --accent: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-hover: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            --accent-glow: #667eea;
            --accent-soft: rgba(102, 126, 234, 0.12);
            --free: #10b981;
            --free-glow: rgba(16, 185, 129, 0.3);
            --busy: #3b82f6;
            --busy-glow: rgba(59, 130, 246, 0.3);
            --booked: #f59e0b;
            --booked-glow: rgba(245, 158, 11, 0.3);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-strong: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.06);
            --border-strong: rgba(255, 255, 255, 0.12);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 24px rgba(102, 126, 234, 0.15);
            --blur: saturate(180%) blur(20px);
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 768px) {
            html {
                font-size: 15px;
            }
        }

        html,
        body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text);
            background: var(--bg);
            background-image:
                radial-gradient(ellipse 120% 80% at 10% -10%, rgba(102, 126, 234, 0.15), transparent 50%),
                radial-gradient(ellipse 100% 70% at 90% 110%, rgba(118, 75, 162, 0.12), transparent 50%),
                radial-gradient(ellipse 80% 60% at 50% 50%, rgba(102, 126, 234, 0.05), transparent 50%);
            background-attachment: fixed;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.08) 0%, transparent 50%);
            animation: bgPulse 20s ease-in-out infinite alternate;
            pointer-events: none;
        }

        @keyframes bgPulse {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        body::after {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
            opacity: 0.5;
        }

        /* Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--space-lg);
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: var(--space-lg);
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 280px 1fr 280px;
                gap: var(--space-md);
                padding: var(--space-md);
            }
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                gap: var(--space-md);
                padding: var(--space-sm);
            }

            #leftSidebar {
                order: 2;
            }

            main {
                order: 1;
            }

            #rightSidebar {
                order: 3;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: var(--space-sm);
                gap: var(--space-sm);
            }
        }

        /* Header */
        .header {
            display: flex;
            gap: var(--space-md);
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: var(--space-lg);
            padding: var(--space-lg);
            background: var(--card);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-strong);
            backdrop-filter: var(--blur);
            box-shadow: var(--shadow-md), var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .header {
                padding: var(--space-md);
                margin-bottom: var(--space-md);
            }
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            flex: 1;
            min-width: 200px;
        }

        .h1 {
            font-size: clamp(1.25rem, 3vw, 1.5rem);
            margin: 0;
            letter-spacing: -0.02em;
            font-weight: 800;
            background: var(--accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .h1 i {
            background: var(--accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .small {
            font-size: 0.875rem;
            color: var(--muted);
            font-weight: 500;
        }

        @media (max-width: 640px) {
            .h1 {
                font-size: 1.125rem;
            }

            .small {
                font-size: 0.8125rem;
            }
        }

        /* Controls */
        .controls {
            margin-left: auto;
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .controls {
                margin-left: 0;
                width: 100%;
                justify-content: flex-start;
            }
        }

        /* Buttons */
        .btn {
            background: var(--glass-strong);
            border: 1px solid var(--border);
            padding: 0.625rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            backdrop-filter: var(--blur);
            font-weight: 500;
            font-size: 0.875rem;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--glass);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-strong);
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn.primary {
            background: var(--accent);
            border: 1px solid rgba(102, 126, 234, 0.3);
            box-shadow: var(--shadow-md), 0 0 20px rgba(102, 126, 234, 0.2);
            color: var(--text-bright);
            font-weight: 600;
        }

        .btn.primary:hover {
            box-shadow: var(--shadow-lg), 0 0 30px rgba(102, 126, 234, 0.3);
        }

        .btn i {
            font-size: 0.875rem;
        }

        @media (max-width: 640px) {
            .btn {
                padding: 0.5rem 0.875rem;
                font-size: 0.8125rem;
                min-height: 44px;
            }
        }

        /* Input fields */
        .input,
        select,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: rgba(15, 21, 32, 0.6);
            color: var(--text);
            transition: all 0.3s ease;
            margin-bottom: var(--space-md);
            font-family: inherit;
            font-size: 0.9375rem;
            backdrop-filter: var(--blur);
        }

        .input::placeholder,
        textarea::placeholder {
            color: rgba(148, 163, 184, 0.5);
        }

        .input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), var(--shadow-sm);
            background: rgba(15, 21, 32, 0.8);
        }

        @media (max-width: 640px) {

            .input,
            select,
            textarea {
                font-size: 1rem;
                min-height: 44px;
            }
        }

        /* Cards */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            backdrop-filter: var(--blur);
            box-shadow: var(--shadow-md);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(102, 126, 234, 0.08), transparent 50%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .card:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            transform: translateY(-2px);
        }

        .card:hover::before,
        .card:hover::after {
            opacity: 1;
        }

        @media (max-width: 640px) {
            .card {
                padding: var(--space-md);
            }
        }

        /* Map */
        .mapWrap {
            height: min(75vh, 700px);
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg), 0 0 0 1px var(--border-strong) inset;
        }

        .mapWrap::after {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.3);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: default;
        }

        @media (max-width: 1024px) {
            .mapWrap {
                height: 60vh;
            }
        }

        @media (max-width: 640px) {
            .mapWrap {
                height: 50vh;
                min-height: 400px;
            }
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            max-height: 50vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: var(--space-xs);
        }

        .list::-webkit-scrollbar {
            width: 6px;
        }

        .list::-webkit-scrollbar-track {
            background: var(--glass);
            border-radius: 3px;
        }

        .list::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        .list {
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.5) transparent;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            background: var(--glass);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .item:hover {
            transform: translateY(-1px);
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: var(--shadow-md), var(--shadow-glow);
            background: var(--glass-strong);
        }

        .item:hover::before {
            opacity: 1;
        }

        @media (max-width: 640px) {
            .item {
                padding: var(--space-sm) var(--space-md);
            }
        }

        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(5, 10, 18, 0.9);
            z-index: 9999;
            backdrop-filter: blur(24px) saturate(180%);
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: var(--space-md);
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modalCard {
            width: 100%;
            max-width: 560px;
            max-height: 90vh;
            background: var(--card);
            padding: var(--space-xl);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-strong);
            box-shadow: var(--shadow-lg), 0 0 60px rgba(102, 126, 234, 0.15);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow-y: auto;
            backdrop-filter: var(--blur);
        }

        .modalCard::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal h3 {
            margin: 0 0 var(--space-lg) 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: var(--space-md);
            font-weight: 700;
            background: var(--accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (max-width: 640px) {
            .modal {
                padding: var(--space-sm);
                align-items: flex-start;
            }

            .modalCard {
                padding: var(--space-lg);
                max-width: 100%;
                margin-top: var(--space-md);
            }

            .modal h3 {
                font-size: 1.25rem;
            }
        }

        /* Tooltip */
        .tooltip {
            position: fixed !important;
            pointer-events: none;
            background: rgba(10, 15, 26, 0.98);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            border: 1px solid var(--border-strong);
            box-shadow: var(--shadow-lg);
            max-width: 320px;
            line-height: 1.5;
            z-index: 2000;
            backdrop-filter: var(--blur);
        }

        /* PC Info Modal */
        .pc-info-modal .modalCard {
            max-width: 480px;
        }

        .pc-info-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: var(--glass);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .pc-status-icon {
            font-size: 1.5rem;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .pc-status-icon.free {
            background: rgba(16, 185, 129, 0.12);
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.2) inset, 0 0 12px var(--free-glow);
        }

        .pc-status-icon.busy {
            background: rgba(59, 130, 246, 0.12);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.2) inset, 0 0 12px var(--busy-glow);
        }

        .pc-status-icon.booked {
            background: rgba(245, 158, 11, 0.12);
            box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.2) inset, 0 0 12px var(--booked-glow);
        }

        /* Utility */
        .skeleton {
            background: linear-gradient(90deg,
                    var(--glass) 0%,
                    var(--glass-strong) 50%,
                    var(--glass) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: var(--space-sm);
        }

        .skeleton-title {
            height: 20px;
            width: 60%;
            margin-bottom: var(--space-md);
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-top-color: var(--accent-glow);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        *:focus-visible {
            outline: 2px solid var(--accent-glow);
            outline-offset: 2px;
        }

        @media (hover: none) and (pointer: coarse) {

            .btn,
            .item {
                min-height: 44px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- –õ–µ–≤—ã–π —Å–∞–π–¥–±–∞—Ä -->
        <aside class="sidebar" id="leftSidebar">
            <div class="card">
                <div class="small"
                    style="margin-bottom:var(--space-md); font-weight:600; display:flex; align-items:center; gap:var(--space-sm);">
                    <i class="fas fa-trophy" style="color:var(--accent-glow);"></i> Achievements
                </div>
                <div id="achievements" class="list"></div>
            </div>

            <div class="card">
                <div class="small"
                    style="margin-bottom:var(--space-md); font-weight:600; display:flex; align-items:center; gap:var(--space-sm);">
                    <i class="fas fa-calendar-check" style="color:var(--booked);"></i> My Bookings
                </div>
                <div id="myBookings" class="list"></div>
            </div>
            <!-- <div class="card">
                <div class="small" style="margin-bottom:8px">üí≥ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π</div>
                <div id="payments" class="list"></div>
            </div> -->
        </aside>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
        <main>
            <div class="header">
                <div class="brand">
                    <div class="h1">
                        <i class="fas fa-gamepad"></i>
                        Cyberbook
                    </div>
                    <div class="small">
                        <i class="fas fa-desktop"></i> Premium Gaming Club
                    </div>
                </div>
                <div class="controls">
                    <select id="groupFilter" class="input" style="width:180px; margin-bottom:0;">
                        <option value="">All Groups</option>
                    </select>
                    <button id="refresh" class="btn">
                        <i class="fas fa-sync-alt"></i>
                        <span class="hide-mobile">Refresh</span>
                    </button>
                    <button onclick="openLeaderboardModal()" class="btn">
                        <i class="fas fa-trophy"></i>
                        <span class="hide-mobile">Leaderboard</span>
                    </button>
                    <button id="gamesBtn" class="btn">
                        <i class="fas fa-gamepad"></i>
                        <span class="hide-mobile">Games</span>
                    </button>
                    <button id="bookSelectedBtn" class="btn primary" style="display:none;">
                        <i class="fas fa-calendar-check"></i>
                        Book (<span id="selectedCount">0</span>)
                    </button>
                    <button id="authBtn" class="btn primary">
                        <i class="fas fa-user-circle"></i>
                        <span class="hide-mobile">Login</span>
                    </button>
                </div>
            </div>

            <div class="card mapWrap" id="mapCard">
                <canvas id="map"></canvas>
            </div>
        </main>

        <!-- –ü—Ä–∞–≤—ã–π —Å–∞–π–¥–±–∞—Ä -->
        <aside class="sidebar" id="rightSidebar">
            <div class="card">
                <div
                    style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-md)">
                    <div class="small" style="font-weight:600; display:flex; align-items:center; gap:var(--space-sm);">
                        <i class="fas fa-chart-pie" style="color:var(--accent-glow);"></i> Summary
                    </div>
                    <div id="userInfo" class="small"
                        style="color:var(--muted); display:flex; align-items:center; gap:var(--space-sm);">
                    </div>
                </div>
                <div id="summary"></div>
            </div>

            <div class="card">
                <div class="small"
                    style="margin-bottom:var(--space-md); font-weight:600; display:flex; align-items:center; gap:var(--space-sm);">
                    <i class="fas fa-clock" style="color:var(--free);"></i> Upcoming Bookings
                </div>
                <div id="upcomingBookings" class="list"></div>
            </div>
        </aside>
    </div>

    <!-- Games Modal -->
    <div id="gamesModal" style="display:none" class="modal">
        <div class="modalCard" style="max-width: 900px;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                <h3><i class="fas fa-gamepad"></i> Club Games</h3>
                <button onclick="closeGamesModal()"
                    style="background:none; border:none; color:var(--muted); cursor:pointer; font-size:28px; transition:color 0.2s;"
                    onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">√ó</button>
            </div>

            <div id="gamesFilter"
                style="margin-bottom: var(--space-md); display:flex; gap:var(--space-md); flex-wrap:wrap; align-items:center;">
                <select id="gameGroupFilter" class="input" style="width: 200px; margin-bottom: 0;">
                    <option value="">All games</option>
                </select>
                <label style="display:flex; align-items:center; gap:var(--space-sm); cursor:pointer;">
                    <input type="checkbox" id="popularOnly" style="cursor:pointer;"> Popular only
                </label>
            </div>

            <div id="gamesGrid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--space-md); max-height: 60vh; overflow-y: auto;">
            </div>
        </div>
    </div>

    <!-- PC Info Modal -->
    <div id="pcInfoModal" style="display:none" class="modal pc-info-modal">
        <div class="modalCard">
            <div class="pc-info-header">
                <div class="pc-status-icon" id="pcStatusIcon"></div>
                <div style="flex:1;">
                    <h3 id="pcInfoTitle" style="margin:0; font-size:1.25rem;"></h3>
                    <div class="small" id="pcInfoGroup"></div>
                </div>
                <button onclick="closePcInfoModal()"
                    style="background:none; border:1px solid var(--border); border-radius:var(--radius-sm); padding:4px 12px; color:var(--muted); cursor:pointer; font-size:20px; transition:all 0.2s;"
                    onmouseover="this.style.borderColor='var(--border-strong)'; this.style.color='var(--text)'"
                    onmouseout="this.style.borderColor='var(--border)'; this.style.color='var(--muted)'">√ó</button>
            </div>

            <div id="pcCurrentStatus"></div>

            <div id="pcBookings" style="display:none">
                <div class="small" style="margin-bottom:var(--space-sm); font-weight:500;">Future bookings:</div>
                <div class="booking-list" id="pcBookingsList"
                    style="display:flex; flex-direction:column; gap:var(--space-sm);"></div>
            </div>

            <div style="display:flex; gap:var(--space-sm); margin-top:var(--space-lg);">
                <button id="pcInfoBookBtn" class="btn primary" style="flex:1">
                    <i class="fas fa-calendar-plus"></i> Book
                </button>
                <button onclick="closePcInfoModal()" class="btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginScreen" style="display:none" class="modal">
        <div class="modalCard">
            <h3><i class="fas fa-sign-in-alt"></i> Client Login</h3>
            <div style="margin-top:var(--space-md)">
                <label class="label small"
                    style="display:block; margin-bottom:var(--space-xs); font-weight:500;">Phone</label>
                <input id="loginInput" class="input" placeholder="+371..." />
            </div>
            <div style="margin-top:var(--space-md)">
                <label class="label small"
                    style="display:block; margin-bottom:var(--space-xs); font-weight:500;">Password</label>
                <input id="passwordInput" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-lg);">
                <button id="loginSubmit" class="btn primary" style="flex:1;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button id="loginCancel" class="btn">Cancel</button>
            </div>
            <div id="loginError" style="color:#f87171;margin-top:var(--space-md); font-size:0.875rem;"></div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" style="display:none" class="modal">
        <div class="modalCard">
            <h3 id="bookingTitle"><i class="fas fa-calendar-check"></i> Book a Seat</h3>
            <div id="selectedHostInfo" style="margin:var(--space-md) 0;color:var(--muted); font-size:0.875rem;"></div>

            <div style="margin-top:var(--space-md)">
                <label class="label small" style="display:block; margin-bottom:var(--space-xs); font-weight:500;">Start
                    time</label>
                <input id="datetime" class="input" type="datetime-local" />
            </div>
            <div style="margin-top:var(--space-md)">
                <label class="label small"
                    style="display:block; margin-bottom:var(--space-xs); font-weight:500;">Duration</label>
                <select id="duration" class="input">
                    <option value="1">1 hour</option>
                    <option value="2">2 hours</option>
                    <option value="3">3 hours</option>
                    <option value="4">4 hours</option>
                    <option value="6">6 hours</option>
                    <option value="8">8 hours</option>
                </select>
            </div>
            <div style="margin-top:var(--space-md)">
                <label class="label small"
                    style="display:block; margin-bottom:var(--space-xs); font-weight:500;">Comment (optional)</label>
                <textarea id="comment" class="input" rows="3" placeholder="Additional requests..."></textarea>
            </div>

            <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-lg)">
                <button id="cancelBooking" class="btn">Cancel</button>
                <button id="confirmBooking" class="btn primary" style="flex:1;">
                    <i class="fas fa-check"></i> Confirm Booking
                </button>
            </div>
            <div id="formMessage" style="margin-top:var(--space-md); font-size:0.875rem;"></div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" style="display:none" class="modal">
        <div class="modalCard" style="max-width:700px;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-lg);">
                <h3 style="margin:0;"><i class="fas fa-trophy"></i> Leaderboard</h3>
                <button onclick="closeLeaderboardModal()"
                    style="background:none; border:none; font-size:28px; cursor:pointer; color:var(--muted); transition:color 0.2s;"
                    onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">√ó</button>
            </div>

            <div id="leaderboardMonth" class="small"
                style="margin-bottom:var(--space-lg); color:var(--muted); font-weight:500;"></div>

            <div id="leaderboardContent" style="display:flex; flex-direction:column; gap:var(--space-sm);">
                <div style="text-align:center; padding:var(--space-xl); color:var(--muted);">
                    <div class="spinner" style="margin:0 auto var(--space-md);"></div>
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip" style="display:none"></div>
    <script>
        let allGames = [];

        async function loadGames() {
            try {
                const res = await fetch('/api/shortcuts', { cache: 'no-store' });
                const games = await res.json();

                if (!Array.isArray(games)) {
                    console.error('Games is not an array:', games);
                    allGames = [];
                    return;
                }

                allGames = games;
                populateGameGroups();
                renderGames(games);
            } catch (err) {
                console.error('Failed to load games:', err);
                allGames = [];
            }
        }

        function populateGameGroups() {
            if (!Array.isArray(allGames)) return;

            const select = document.getElementById('gameGroupFilter');
            const groups = [...new Set(allGames.map(g => g.group?.title).filter(Boolean))];

            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                select.appendChild(option);
            });
        }

        function filterGames() {
            const groupFilter = document.getElementById('gameGroupFilter').value;
            const popularOnly = document.getElementById('popularOnly').checked;

            let filtered = allGames;

            if (groupFilter) {
                filtered = filtered.filter(g => g.group?.title === groupFilter);
            }

            if (popularOnly) {
                filtered = filtered.filter(g => g.popular);
            }

            renderGames(filtered);
        }

        function renderGames(games) {
            const grid = document.getElementById('gamesGrid');
            const gamesOnly = games.filter(game => game.type !== 'APPLICATION');

            if (!gamesOnly || gamesOnly.length === 0) {
                grid.innerHTML = '<div style="color:var(--muted); text-align: center; grid-column: 1/-1; padding:var(--space-xl);">No games found</div>';
                return;
            }

            grid.innerHTML = gamesOnly.map(game => {
                const ageRating = game.age_rating ? `${game.age_rating}+` : '';
                const popular = game.popular ? '‚≠ê ' : '';
                const freeRun = game.free_run ? 'üÜì ' : '';

                let iconHtml;
                if (game.icon_path) {
                    iconHtml = `<img src="${game.icon_path}" style="width: 48px; height: 48px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                       <div style="font-size: 32px; display: none;">üéÆ</div>`;
                } else if (game.main_picture) {
                    iconHtml = `<img src="${game.main_picture}" style="width: 48px; height: 48px; object-fit: cover; border-radius: var(--radius-sm);" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                       <div style="font-size: 32px; display: none;">üéÆ</div>`;
                } else {
                    iconHtml = `<div style="font-size: 32px;">üéÆ</div>`;
                }

                return `
                    <div class="card" style="padding: var(--space-md); display: flex; flex-direction: column;">
                        <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                            ${iconHtml}
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; margin-bottom: var(--space-xs); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${popular}${game.title || 'No title'}</div>
                                <div class="small">${game.group?.title || 'No group'}</div>
                            </div>
                        </div>

                        <div style="margin-top: auto; display: flex; justify-content: space-between; align-items: center; gap: var(--space-sm);">
                            <div style="display:flex; gap:var(--space-xs); flex-wrap:wrap;">
                                ${ageRating ? `<span style="background: var(--booked); color: var(--bg); padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600;">${ageRating}</span>` : ''}
                                ${freeRun ? '<span style="color: var(--free); font-size:0.875rem; font-weight:500;">Free</span>' : ''}
                            </div>
                            <div class="small" style="color: var(--muted);">${game.type || ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openGamesModal() {
            document.getElementById('gamesModal').style.display = 'flex';
            if (allGames.length === 0) {
                loadGames();
            }
        }

        function closeGamesModal() {
            document.getElementById('gamesModal').style.display = 'none';
        }

        document.getElementById('gamesBtn').addEventListener('click', openGamesModal);
        document.getElementById('gameGroupFilter').addEventListener('change', filterGames);
        document.getElementById('popularOnly').addEventListener('change', filterGames);

        // Canvas & Map
        const canvas = document.getElementById('map');
        const ctx = canvas.getContext('2d');
        const state = {
            hosts: [],
            bookings: [],
            scale: 48,
            padding: 36,
            offsetX: 0,
            offsetY: 0,
            selectedGroup: '',
            hoveredHost: null,
            selectedHost: null,
            selectedHosts: new Set()
        };

        function resizeCanvas() {
            const r = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = Math.floor(r.width * dpr);
            canvas.height = Math.floor(r.height * dpr);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        function colorFor(h) {
            if (h.session) return getComputedStyle(document.documentElement).getPropertyValue('--busy').trim() || '#3b82f6';
            const hasBooking = state.bookings.some(b => b.hosts.some(bh => bh.id == h.id));
            if (hasBooking) return getComputedStyle(document.documentElement).getPropertyValue('--booked').trim() || '#f59e0b';
            return getComputedStyle(document.documentElement).getPropertyValue('--free').trim() || '#10b981';
        }

        function getStatusEmoji(h) {
            if (h.session) return '‚óè';
            const now = new Date();
            const hasActiveBooking = state.bookings.some(b => {
                const bookingStart = new Date(b.from);
                const bookingEnd = new Date(b.to);
                return b.hosts.some(bh => bh.id == h.id) && bookingStart <= now && bookingEnd > now;
            });
            if (hasActiveBooking) return '‚óÜ';

            const hasFutureBooking = state.bookings.some(b => {
                const bookingStart = new Date(b.from);
                return b.hosts.some(bh => bh.id == h.id) && bookingStart > now;
            });
            if (hasFutureBooking) return '‚óá';
            return '‚óã';
        }

        async function loadBookings() {
            try {
                const res = await fetch('/api/bookings', { cache: 'no-store' });
                if (!res.ok) {
                    console.error('Failed to fetch bookings:', res.status);
                    return;
                }
                const bookings = await res.json();
                if (!Array.isArray(bookings)) {
                    console.error('Bookings response is not an array:', bookings);
                    state.bookings = [];
                    return;
                }
                state.bookings = bookings;
                renderUpcomingBookings(state.bookings);
                renderSummary(state.hosts);
                draw();
            } catch (err) {
                console.error('Error loading bookings:', err);
                state.bookings = [];
            }
        }

        function renderUpcomingBookings(bookings) {
            const el = document.getElementById('upcomingBookings');

            const now = new Date();
            const futureBookings = bookings.filter(b => {
                const bookingStart = new Date(b.from);
                return bookingStart > now;
            });

            if (!futureBookings || futureBookings.length === 0) {
                el.innerHTML = '<div class="small" style="color:var(--muted);padding:var(--space-md);text-align:center;">No upcoming bookings</div>';
                return;
            }

            el.innerHTML = futureBookings.slice(0, 5).map(b => {
                const fromDate = new Date(b.from);
                const toDate = new Date(b.to);
                const dateStr = fromDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                const fromTime = fromDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const toTime = toDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const hostNames = b.hosts.map(h => h.alias || `PC ${h.id}`).join(', ');
                const clientName = b.client?.nickname || b.client?.phone || 'Guest';

                return `
                    <div class="item" style="display:block; padding:var(--space-md);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:var(--space-sm);">
                            <div style="font-weight:600; display:flex; align-items:center; gap:var(--space-sm);">
                                <i class="fas fa-desktop" style="color:var(--accent-glow); font-size:0.875rem;"></i>
                                ${hostNames}
                            </div>
                        </div>
                        <div class="small" style="color:var(--muted); margin-bottom:var(--space-xs);">
                            <i class="fas fa-user" style="font-size:0.75rem;"></i> ${clientName}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="small" style="color:var(--muted);">
                                <i class="fas fa-calendar" style="font-size:0.75rem;"></i> ${dateStr}
                            </div>
                            <div style="font-size:0.875rem; color:var(--booked); font-weight:500;">
                                ${fromTime} - ${toTime}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function computeBounds(hosts) {
            const withCoords = hosts.filter(h => Number.isFinite(h.coord_x) && Number.isFinite(h.coord_y));
            if (!withCoords.length) return { minX: 0, minY: 0, maxX: 1, maxY: 1 };
            const xs = withCoords.map(h => h.coord_x);
            const ys = withCoords.map(h => h.coord_y);
            return { minX: Math.min(...xs), minY: Math.min(...ys), maxX: Math.max(...xs), maxY: Math.max(...ys) }
        }

        function fitToView() {
            const pad = state.padding;
            const r = canvas.getBoundingClientRect();
            const b = computeBounds(filtered(state.hosts));
            const widthCells = (b.maxX - b.minX + 1) || 1;
            const heightCells = (b.maxY - b.minY + 1) || 1;
            const sx = (r.width - pad * 2) / widthCells;
            const sy = (r.height - pad * 2) / heightCells;
            state.scale = Math.max(28, Math.floor(Math.min(sx, sy)));
            const gridW = widthCells * state.scale;
            const gridH = heightCells * state.scale;
            state.offsetX = pad + Math.floor((r.width - pad * 2 - gridW) / 2);
            state.offsetY = pad + Math.floor((r.height - pad * 2 - gridH) / 2);
        }

        function filtered(hosts) {
            if (!state.selectedGroup) return hosts;
            return hosts.filter(h => h.group?.id === state.selectedGroup)
        }

        function draw() {
            resizeCanvas();
            const hosts = filtered(state.hosts);
            const r = canvas.getBoundingClientRect();
            ctx.clearRect(0, 0, r.width, r.height);
            ctx.fillStyle = '#07121b';
            ctx.fillRect(0, 0, r.width, r.height);
            if (!draw._fittedOnce) { fitToView(); draw._fittedOnce = true }

            const b = computeBounds(hosts);
            ctx.strokeStyle = 'rgba(255,255,255,0.03)';
            ctx.lineWidth = 1;

            for (let x = b.minX; x <= b.maxX + 1; x++) {
                const px = state.offsetX + (x - b.minX) * state.scale;
                ctx.beginPath(); ctx.moveTo(px, state.offsetY); ctx.lineTo(px, r.height - state.offsetY); ctx.stroke()
            }
            for (let y = b.minY; y <= b.maxY + 1; y++) {
                const py = state.offsetY + (y - b.minY) * state.scale;
                ctx.beginPath(); ctx.moveTo(state.offsetX, py); ctx.lineTo(r.width - state.offsetX, py); ctx.stroke()
            }

            ctx.textBaseline = 'middle';
            ctx.font = '12px Inter, system-ui';

            for (const h of hosts) {
                if (!Number.isFinite(h.coord_x) || !Number.isFinite(h.coord_y)) continue;
                const gx = (h.coord_x - b.minX), gy = (h.coord_y - b.minY);
                const cx = state.offsetX + gx * state.scale + state.scale / 2;
                const cy = state.offsetY + gy * state.scale + state.scale / 2;
                const w = Math.max(state.scale - 8, 36);
                const hgt = Math.max(state.scale - 8, 38);
                const x = cx - w / 2, y = cy - hgt / 2;
                const isHovered = state.hoveredHost && state.hoveredHost.id === h.id;
                const isSelected = state.selectedHosts.has(h.id);

                ctx.fillStyle = colorFor(h);
                if (isHovered) ctx.globalAlpha = 0.85;
                roundRect(ctx, x, y, w, hgt, 8);
                ctx.fill();
                ctx.globalAlpha = 1;

                if (isSelected) {
                    ctx.strokeStyle = '#00bcd4';
                    ctx.lineWidth = 3;
                    roundRect(ctx, x, y, w, hgt, 8);
                    ctx.stroke();
                }

                const emoji = getStatusEmoji(h);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#ffffff';
                const emojiWidth = ctx.measureText(emoji).width;
                ctx.fillText(emoji, cx - emojiWidth / 2, cy - 8);

                ctx.font = '11px Inter, system-ui';
                ctx.fillStyle = '#061226';
                const label = h.alias ?? '‚Äî';
                clipText(ctx, label, x + 8, cy + 8, w - 16);

                if (h.session) {
                    ctx.fillStyle = 'rgba(184,195,211,0.9)';
                    let timeText = '';
                    if (h.session.time_left && h.session.time_left > 0) {
                        const endTime = new Date(Date.now() + h.session.time_left * 1000);
                        timeText = '–¥–æ ' + endTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    } else if (h.session.started_at && h.session.duration) {
                        const start = new Date(h.session.started_at);
                        const end = new Date(start.getTime() + h.session.duration * 1000);
                        timeText = '–¥–æ ' + end.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    }
                    if (timeText) clipText(ctx, timeText, x + 8, cy + 18, w - 16);
                }
            }
        }

        function roundRect(ctx, x, y, w, h, r) {
            const rr = Math.min(r, w / 2, h / 2);
            ctx.beginPath();
            ctx.moveTo(x + rr, y);
            ctx.arcTo(x + w, y, x + w, y + h, rr);
            ctx.arcTo(x + w, y + h, x, y + h, rr);
            ctx.arcTo(x, y + h, x, y, rr);
            ctx.arcTo(x, y, x + w, y, rr);
            ctx.closePath();
        }

        function clipText(ctx, text, x, midY, maxW) {
            let t = String(text ?? "");
            while (ctx.measureText(t).width > maxW && t.length > 1) t = t.slice(0, -1);
            if (t !== text && maxW > 10) t = t.slice(0, -1) + '‚Ä¶';
            ctx.fillText(t, x, midY)
        }

        function getHostAtPosition(x, y) {
            const hosts = filtered(state.hosts);
            const b = computeBounds(hosts);
            for (const h of hosts) {
                if (!Number.isFinite(h.coord_x) || !Number.isFinite(h.coord_y)) continue;
                const gx = (h.coord_x - b.minX), gy = (h.coord_y - b.minY);
                const cx = state.offsetX + gx * state.scale + state.scale / 2;
                const cy = state.offsetY + gy * state.scale + state.scale / 2;
                const w = Math.max(state.scale - 8, 36);
                const hgt = Math.max(state.scale - 8, 38);
                const hx = cx - w / 2;
                const hy = cy - hgt / 2;
                if (x >= hx && x <= hx + w && y >= hy && y <= hy + hgt) return h
            }
            return null
        }

        function openPcInfoModal(host) {
            state.selectedHost = host;
            const modal = document.getElementById('pcInfoModal');
            const icon = document.getElementById('pcStatusIcon');
            const title = document.getElementById('pcInfoTitle');
            const group = document.getElementById('pcInfoGroup');
            const status = document.getElementById('pcCurrentStatus');
            const bookingsDiv = document.getElementById('pcBookings');
            const bookingsList = document.getElementById('pcBookingsList');
            const bookBtn = document.getElementById('pcInfoBookBtn');

            title.textContent = host.alias || `PC ${host.id}`;
            group.textContent = host.group?.title || 'No group';

            if (host.session) {
                icon.textContent = '‚óè';
                icon.className = 'pc-status-icon busy';
                let sessionInfo = host.session.user || 'Unknown';
                let timeInfo = '';
                if (host.session.time_left && host.session.time_left > 0) {
                    const hours = Math.floor(host.session.time_left / 3600);
                    const minutes = Math.floor((host.session.time_left % 3600) / 60);
                    timeInfo = hours > 0 ? `${hours}h ${minutes}m left` : `${minutes}m left`;
                }
                status.innerHTML = `<div style="color:var(--busy); font-weight:600; margin-bottom:var(--space-xs);">‚óè In Use</div>
                    <div class="small">User: ${sessionInfo}</div>
                    ${timeInfo ? `<div class="small" style="color:var(--muted);">‚è± ${timeInfo}</div>` : ''}`;
                bookBtn.disabled = true;
                bookBtn.style.opacity = '0.5';
                bookBtn.style.cursor = 'not-allowed';
                bookBtn.innerHTML = '<i class="fas fa-ban"></i> In Use';
            } else {
                const now = new Date();
                const activeBooking = state.bookings.find(b => {
                    const bookingStart = new Date(b.from);
                    const bookingEnd = new Date(b.to);
                    return b.hosts.some(bh => bh.id == host.id) && bookingStart <= now && bookingEnd > now;
                });
                const futureBooking = state.bookings.find(b => {
                    const bookingStart = new Date(b.from);
                    return b.hosts.some(bh => bh.id == host.id) && bookingStart > now;
                });

                if (activeBooking) {
                    icon.textContent = '‚óÜ';
                    icon.className = 'pc-status-icon booked';
                    const toTime = new Date(activeBooking.to).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    status.innerHTML = `<div style="color:var(--booked); font-weight:600;">‚óÜ Currently Booked</div>
                        <div class="small" style="color:var(--muted);">Until ${toTime}</div>`;
                } else if (futureBooking) {
                    icon.textContent = '‚óá';
                    icon.className = 'pc-status-icon booked';
                    const fromTime = new Date(futureBooking.from).toLocaleString('en-US', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    status.innerHTML = `<div style="color:var(--booked); font-weight:600;">‚óá Future Booking</div>
                        <div class="small" style="color:var(--muted);">From ${fromTime}</div>`;
                } else {
                    icon.textContent = '‚óã';
                    icon.className = 'pc-status-icon free';
                    status.innerHTML = `<div style="color:var(--free); font-weight:600;">‚óã Available</div>`;
                }
                bookBtn.disabled = false;
                bookBtn.style.opacity = '1';
                bookBtn.style.cursor = 'pointer';
                bookBtn.innerHTML = '<i class="fas fa-calendar-plus"></i> Book';
            }

            const hostBookings = state.bookings.filter(b => b.hosts.some(bh => bh.id == host.id));

            if (hostBookings.length > 0) {
                bookingsDiv.style.display = 'block';
                bookingsList.innerHTML = hostBookings.map(b => {
                    const fromTime = new Date(b.from).toLocaleString('en-US', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const toTime = new Date(b.to).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const client = b.client?.nickname || b.client?.phone || 'Guest';
                    return `
                        <div class="item" style="display:block; padding:var(--space-md);">
                            <div style="display:flex; justify-content:space-between; margin-bottom:var(--space-xs);">
                                <div style="font-weight:600; color:var(--booked);">${fromTime} - ${toTime}</div>
                                <div class="small" style="color:var(--booked);">${b.status}</div>
                            </div>
                            <div class="small" style="color:var(--muted);">
                                <i class="fas fa-user" style="font-size:0.75rem;"></i> ${client}
                            </div>
                        </div>`;
                }).join('');
            } else {
                bookingsDiv.style.display = 'none';
            }
            modal.style.display = 'flex';
        }

        function closePcInfoModal() {
            document.getElementById('pcInfoModal').style.display = 'none';
            state.selectedHost = null;
        }

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const host = getHostAtPosition(x, y);
            const tooltip = document.getElementById('tooltip');

            if (host) {
                state.hoveredHost = host;
                canvas.style.cursor = 'pointer';

                let tooltipText = `${getStatusEmoji(host)} ${host.alias ?? 'Seat ' + host.id}`;
                if (host.group?.title) tooltipText += ` ‚Ä¢ ${host.group.title}`;

                const now = new Date();
                const activeBooking = state.bookings.find(b => {
                    const bookingStart = new Date(b.from);
                    const bookingEnd = new Date(b.to);
                    return b.hosts.some(bh => bh.id == host.id) && bookingStart <= now && bookingEnd > now;
                });
                if (activeBooking) {
                    const fromDate = new Date(activeBooking.from);
                    const toDate = new Date(activeBooking.to);
                    const dateStr = fromDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                    const fromTime = fromDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const toTime = toDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    tooltipText += `<br>‚óÜ Booked: ${dateStr}, ${fromTime} - ${toTime}`;
                    if (activeBooking.client?.nickname) tooltipText += ` (${activeBooking.client.nickname})`;
                } else {
                    const futureBooking = state.bookings.find(b => {
                        const bookingStart = new Date(b.from);
                        return b.hosts.some(bh => bh.id == host.id) && bookingStart > now;
                    });
                    if (futureBooking) {
                        const fromDate = new Date(futureBooking.from);
                        const dateStr = fromDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                        const fromTime = fromDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        tooltipText += `<br>‚óá Future: ${dateStr}, ${fromTime}`;
                        if (futureBooking.client?.nickname) tooltipText += ` (${futureBooking.client.nickname})`;
                    }
                }

                if (host.session) {
                    tooltipText += host.session.user ? `<br>‚óè Playing: ${host.session.user}` : `<br>‚óè In Use`;

                    let timeLeft = null;
                    if (host.session.time_left && host.session.time_left > 0) {
                        timeLeft = host.session.time_left;
                    } else if (host.session.started_at && host.session.duration) {
                        const start = new Date(host.session.started_at);
                        const end = new Date(start.getTime() + host.session.duration * 1000);
                        timeLeft = Math.max(0, Math.floor((end.getTime() - Date.now()) / 1000));
                    }

                    if (timeLeft && timeLeft > 0) {
                        const hours = Math.floor(timeLeft / 3600);
                        const minutes = Math.floor((timeLeft % 3600) / 60);
                        tooltipText += hours > 0 ? `<br>‚è± Remaining: ${hours}h ${minutes}m` : `<br>‚è± Remaining: ${minutes}m`;
                    }
                }

                tooltip.innerHTML = tooltipText;
                tooltip.style.display = 'block';

                const mouseX = e.clientX;
                const mouseY = e.clientY;

                requestAnimationFrame(() => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    const offset = 20;

                    let tooltipX = mouseX + offset;
                    let tooltipY = mouseY + offset;

                    if (tooltipX + tooltipRect.width > window.innerWidth - 10) {
                        tooltipX = mouseX - tooltipRect.width - offset;
                    }

                    if (tooltipY + tooltipRect.height > window.innerHeight - 10) {
                        tooltipY = mouseY - tooltipRect.height - offset;
                    }

                    tooltip.style.left = tooltipX + 'px';
                    tooltip.style.top = tooltipY + 'px';
                });

                draw();
            } else {
                state.hoveredHost = null;
                canvas.style.cursor = 'default';
                tooltip.style.display = 'none';
                draw();
            }
        });

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const host = getHostAtPosition(x, y);
            if (host) {
                if (e.ctrlKey || e.metaKey) {
                    if (!host.session) {
                        if (state.selectedHosts.has(host.id)) {
                            state.selectedHosts.delete(host.id);
                        } else {
                            state.selectedHosts.add(host.id);
                        }
                        updateSelectedCount();
                        draw();
                    }
                } else {
                    openPcInfoModal(host);
                }
            }
        });

        function updateSelectedCount() {
            const count = state.selectedHosts.size;
            const btn = document.getElementById('bookSelectedBtn');
            const countEl = document.getElementById('selectedCount');

            if (count > 0) {
                btn.style.display = 'inline-flex';
                countEl.textContent = count;
            } else {
                btn.style.display = 'none';
            }
        }

        document.getElementById('pcInfoBookBtn').addEventListener('click', () => {
            if (state.selectedHost) {
                const hostToBook = state.selectedHost;
                closePcInfoModal();
                if (!isLoggedIn()) {
                    alert('You need to login to book');
                    document.getElementById('loginScreen').style.display = 'flex';
                    return;
                }
                openBookingModal(hostToBook);
            }
        });

        document.getElementById('bookSelectedBtn').addEventListener('click', () => {
            if (state.selectedHosts.size === 0) return;

            if (!isLoggedIn()) {
                alert('You need to login to book');
                document.getElementById('loginScreen').style.display = 'flex';
                return;
            }

            openBookingModalMultiple(Array.from(state.selectedHosts));
        });

        function openBookingModalMultiple(hostIds) {
            const validHosts = hostIds.filter(id => {
                const host = state.hosts.find(h => h.id === id);
                return host && !host.session;
            });

            if (validHosts.length === 0) {
                alert('All selected PCs are busy');
                return;
            }

            const hostNames = validHosts.map(id => {
                const host = state.hosts.find(h => h.id === id);
                return host?.alias || `PC ${id}`;
            }).join(', ');

            document.getElementById('bookingTitle').innerHTML = '<i class="fas fa-calendar-check"></i> Book Seats (' + validHosts.length + ')';
            document.getElementById('selectedHostInfo').textContent = hostNames;
            state.bookingHostIds = validHosts;

            const now = new Date();
            const rigaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/Riga' }));
            rigaTime.setMinutes(rigaTime.getMinutes() + 30);
            const year = rigaTime.getFullYear();
            const month = String(rigaTime.getMonth() + 1).padStart(2, '0');
            const day = String(rigaTime.getDate()).padStart(2, '0');
            const hours = String(rigaTime.getHours()).padStart(2, '0');
            const minutes = String(rigaTime.getMinutes()).padStart(2, '0');
            const min = `${year}-${month}-${day}T${hours}:${minutes}`;
            const dt = document.getElementById('datetime');
            dt.min = min;
            dt.value = min;
            document.getElementById('bookingModal').style.display = 'flex';
        }

        window.addEventListener('resize', () => { draw._fittedOnce = false; draw(); });

        async function loadHosts() {
            try {
                const res = await fetch('/api/hosts', { cache: 'no-store' });
                if (!res.ok) {
                    console.error('Failed to fetch hosts:', res.status);
                    return;
                }
                const hosts = await res.json();
                if (!Array.isArray(hosts)) {
                    console.error('Hosts response is not an array:', hosts);
                    return;
                }
                state.hosts = hosts;
                renderSummary(hosts);
                ensureGroups(hosts);
                draw();
            } catch (err) {
                console.error('Error loading hosts:', err);
            }
        }

        function renderSummary(hosts) {
            const busy = hosts.filter(h => h.session !== null).length;

            const bookedHostIds = new Set();
            if (state.bookings) {
                state.bookings.forEach(booking => {
                    if (Array.isArray(booking.hosts)) {
                        booking.hosts.forEach(host => {
                            const hostInHosts = hosts.find(h => h.id == host.id);
                            if (hostInHosts && !hostInHosts.session) {
                                bookedHostIds.add(host.id);
                            }
                        });
                    }
                });
            }
            const booked = bookedHostIds.size;

            const free = Math.max(0, hosts.length - busy - booked);
            const total = hosts.length;
            const freePercent = total > 0 ? Math.round((free / total) * 100) : 0;
            const busyPercent = total > 0 ? Math.round((busy / total) * 100) : 0;
            const bookedPercent = total > 0 ? Math.round((booked / total) * 100) : 0;

            document.getElementById('summary').innerHTML = `
                <div style="display:flex;gap:var(--space-md);align-items:center;padding:var(--space-md) 0;">
                    <i class="fas fa-circle" style="color:var(--free);font-size:10px;"></i>
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-xs);">
                            <span style="font-size:0.875rem; font-weight:500;">Available</span>
                            <strong style="color:var(--free); font-weight:700;">${free}</strong>
                        </div>
                        <div style="background:rgba(16,185,129,0.1);height:8px;border-radius:var(--radius-sm);overflow:hidden;">
                            <div style="background:var(--free);height:100%;width:${freePercent}%;transition:width 0.5s cubic-bezier(0.4, 0, 0.2, 1);box-shadow:0 0 8px var(--free-glow);"></div>
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:var(--space-md);align-items:center;padding:var(--space-md) 0;">
                    <i class="fas fa-circle" style="color:var(--busy);font-size:10px;"></i>
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-xs);">
                            <span style="font-size:0.875rem; font-weight:500;">In Use</span>
                            <strong style="color:var(--busy); font-weight:700;">${busy}</strong>
                        </div>
                        <div style="background:rgba(59,130,246,0.1);height:8px;border-radius:var(--radius-sm);overflow:hidden;">
                            <div style="background:var(--busy);height:100%;width:${busyPercent}%;transition:width 0.5s cubic-bezier(0.4, 0, 0.2, 1);box-shadow:0 0 8px var(--busy-glow);"></div>
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:var(--space-md);align-items:center;padding:var(--space-md) 0;">
                    <i class="fas fa-circle" style="color:var(--booked);font-size:10px;"></i>
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-xs);">
                            <span style="font-size:0.875rem; font-weight:500;">Booked (24h)</span>
                            <strong style="color:var(--booked); font-weight:700;">${booked}</strong>
                        </div>
                        <div style="background:rgba(245,158,11,0.1);height:8px;border-radius:var(--radius-sm);overflow:hidden;">
                            <div style="background:var(--booked);height:100%;width:${bookedPercent}%;transition:width 0.5s cubic-bezier(0.4, 0, 0.2, 1);box-shadow:0 0 8px var(--booked-glow);"></div>
                        </div>
                    </div>
                </div>`;
        }

        async function loadMyBookings() {
            const container = document.getElementById('myBookings');

            if (!isLoggedIn()) {
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:var(--space-md);text-align:center;"><i class="fas fa-lock" style="margin-right:var(--space-xs);"></i>Login to view bookings</div>';
                return;
            }

            container.innerHTML = `
                <div class="item">
                    <div style="flex:1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width:50%;"></div>
                    </div>
                </div>
            `;

            try {
                const user = JSON.parse(localStorage.getItem('user'));
                const allBookings = await fetch('/api/bookings', { cache: 'no-store' }).then(r => r.json());

                const now = new Date();
                const myBookings = allBookings.filter(b => {
                    const bookingEnd = new Date(b.to);
                    return b.client?.id === user.id &&
                        (b.status === 'PENDING' || b.status === 'ACTIVE') &&
                        bookingEnd > now;
                });

                if (myBookings.length === 0) {
                    container.innerHTML = '<div class="small" style="color:var(--muted);padding:var(--space-md);text-align:center;"><i class="fas fa-inbox" style="margin-right:var(--space-xs);"></i>No active bookings</div>';
                    return;
                }

                container.innerHTML = myBookings.map(b => {
                    const fromDate = new Date(b.from);
                    const toDate = new Date(b.to);
                    const dateStr = fromDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                    const fromTime = fromDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const toTime = toDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const hostNames = b.hosts.map(h => h.alias || `PC ${h.id}`).join(', ');

                    return `
                        <div class="item" style="display:block; padding:var(--space-md);">
                            <div style="display:flex; justify-content:space-between; margin-bottom:var(--space-sm);">
                                <div style="font-weight:600; display:flex; align-items:center; gap:var(--space-sm);">
                                    <i class="fas fa-desktop" style="color:var(--accent-glow);font-size:0.875rem;"></i>
                                    ${hostNames}
                                </div>
                                <button onclick="cancelBooking(${b.id})"
                                    style="background:none; border:1px solid rgba(248,113,113,0.5); color:#f87171; padding:4px 12px; border-radius:var(--radius-sm); cursor:pointer; font-size:0.75rem; font-weight:500; transition:all 0.2s;"
                                    onmouseover="this.style.background='rgba(248,113,113,0.1)'"
                                    onmouseout="this.style.background='none'">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                            <div class="small" style="color:var(--muted); margin-bottom:var(--space-xs);">
                                <i class="fas fa-calendar" style="font-size:0.75rem;"></i> ${dateStr} ‚Ä¢ ${fromTime} - ${toTime}
                            </div>
                            <div class="small" style="color:var(--booked); font-weight:500;">
                                <i class="fas fa-info-circle" style="font-size:0.75rem;"></i> ${b.status}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Failed to load my bookings:', err);
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:var(--space-md);text-align:center;">Loading error</div>';
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Cancel this booking?')) return;

            try {
                const res = await fetch(`/api/bookings/${bookingId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('sessionId'),
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    const json = await res.json();
                    throw new Error(json.error || 'Cancel error');
                }

                alert('‚úì Booking cancelled');
                await loadBookings();
                await loadMyBookings();
                await loadHosts();
            } catch (err) {
                alert('√ó ' + err.message);
            }
        }

        async function loadAchievements() {
            const container = document.getElementById('achievements');

            if (!isLoggedIn()) {
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:var(--space-md);text-align:center;"><i class="fas fa-lock" style="margin-right:var(--space-xs);"></i>Login to view achievements</div>';
                return;
            }

            container.innerHTML = `
                <div class="item">
                    <div style="flex:1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width:40%;"></div>
                    </div>
                </div>
                <div class="item">
                    <div style="flex:1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width:40%;"></div>
                    </div>
                </div>
            `;

            try {
                const res = await fetch('/api/achievements', {
                    cache: 'no-store',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('sessionId')
                    }
                });
                const achievements = await res.json();

                if (!achievements || achievements.length === 0) {
                    container.innerHTML = '<div class="small" style="color:var(--muted);padding:var(--space-md);text-align:center;">No achievements yet</div>';
                    return;
                }

                container.innerHTML = achievements.map(ach => {
                    const condition = ach.conditions?.[0];
                    const reward = ach.rewards?.[0];

                    if (!condition) return '';

                    let currentValue = 0;
                    let targetValue = condition.value;
                    let unit = '';
                    let icon = 'üèÜ';

                    if (condition.name === 'spent_hours') {
                        currentValue = Math.floor((ach.progress / 100) * (targetValue / 3600));
                        targetValue = Math.floor(targetValue / 3600);
                        unit = ' h';
                        icon = '‚è±Ô∏è';
                    } else if (condition.name === 'add_deposit_overall') {
                        currentValue = Math.floor((ach.progress / 100) * targetValue);
                        unit = '‚Ç¨';
                        icon = 'üí∞';
                    } else if (condition.name === 'register') {
                        currentValue = ach.progress;
                        targetValue = 1;
                        icon = '‚úì';
                    } else {
                        currentValue = Math.floor((ach.progress / 100) * targetValue);
                    }

                    const percentage = Math.min(100, Math.floor(ach.progress));
                    const isCompleted = ach.has || percentage >= 100;

                    let rewardText = '';
                    if (reward && reward.name === 'add_deposit') {
                        rewardText = `<div class="small" style="color: var(--accent-glow); margin-top: var(--space-xs); font-weight:500;">üéÅ Reward: ${reward.value}‚Ç¨</div>`;
                    }

                    return `
                        <div class="item" style="display: block; padding: var(--space-md); ${isCompleted ? 'background: rgba(16, 185, 129, 0.08); border-color: rgba(16, 185, 129, 0.2);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                                <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                    ${ach.icon_url ? `<img src="${ach.icon_url}" style="width: 24px; height: 24px; object-fit: contain;" />` : `<span style="font-size:1.25rem;">${icon}</span>`}
                                    <div style="font-weight: 600; font-size:0.9375rem;">${isCompleted ? '‚úì ' : ''}${ach.name || 'Achievement'}</div>
                                </div>
                                <div class="small" style="font-weight: 700;">${currentValue}${unit} / ${targetValue}${unit}</div>
                            </div>
                            <div style="background: var(--glass); height: 8px; border-radius: var(--radius-sm); overflow: hidden; margin-bottom: var(--space-xs);">
                                <div style="background: ${isCompleted ? 'var(--free)' : 'var(--accent-glow)'}; height: 100%; width: ${percentage}%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 8px ${isCompleted ? 'var(--free-glow)' : 'rgba(102, 126, 234, 0.3)'};"></div>
                            </div>
                            ${rewardText}
                        </div>
                    `;
                }).filter(Boolean).join('');

            } catch (err) {
                console.error('Failed to load achievements:', err);
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:var(--space-md);text-align:center;">Loading error</div>';
            }
        }

        function ensureGroups(hosts) {
            const sel = document.getElementById('groupFilter');
            const exists = new Set(Array.from(sel.options).map(o => o.value));

            hosts.forEach(h => {
                if (h.group?.id && !exists.has(h.group.id)) {
                    const op = document.createElement('option');
                    op.value = h.group.id;
                    op.textContent = h.group.title || h.group.id;
                    sel.appendChild(op);
                    exists.add(h.group.id);
                }
            });
        }

        document.getElementById('groupFilter').addEventListener('change', (e) => {
            state.selectedGroup = e.target.value;
            draw._fittedOnce = false;
            draw();
        });

        document.getElementById('refresh').addEventListener('click', (e) => {
            const icon = e.currentTarget.querySelector('i');
            if (icon) {
                icon.style.animation = 'spin 0.8s linear';
                setTimeout(() => { icon.style.animation = ''; }, 800);
            }
            loadHosts();
            loadBookings();
        });

        function openBookingModal(host) {
            state.selectedHost = host;
            document.getElementById('bookingTitle').innerHTML = '<i class="fas fa-calendar-check"></i> ' + (host.alias || ('Seat ' + host.id));
            document.getElementById('selectedHostInfo').textContent = host.group && host.group.title ? host.group.title : '';
            const now = new Date();
            const rigaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/Riga' }));
            rigaTime.setMinutes(rigaTime.getMinutes() + 30);
            const year = rigaTime.getFullYear();
            const month = String(rigaTime.getMonth() + 1).padStart(2, '0');
            const day = String(rigaTime.getDate()).padStart(2, '0');
            const hours = String(rigaTime.getHours()).padStart(2, '0');
            const minutes = String(rigaTime.getMinutes()).padStart(2, '0');
            const min = `${year}-${month}-${day}T${hours}:${minutes}`;
            const dt = document.getElementById('datetime');
            dt.min = min;
            dt.value = min;
            document.getElementById('bookingModal').style.display = 'flex';
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
            document.getElementById('formMessage').innerHTML = '';
            state.selectedHost = null;
        }

        document.getElementById('cancelBooking').addEventListener('click', closeBookingModal);

        function isLoggedIn() {
            const sessionId = localStorage.getItem('sessionId');
            const user = localStorage.getItem('user');
            return !!(sessionId && user);
        }

        document.getElementById('confirmBooking').addEventListener('click', async () => {
            if (!isLoggedIn()) {
                alert('Session expired. Please login again.');
                document.getElementById('bookingModal').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                return;
            }
            const datetime = document.getElementById('datetime').value;
            const durationHours = Number(document.getElementById('duration').value);
            const comment = document.getElementById('comment').value.trim();
            const msg = document.getElementById('formMessage');
            msg.innerHTML = '';

            if (!datetime) {
                msg.innerHTML = '<div style="color:#f87171">√ó Select time</div>';
                return;
            }

            const fromIso = new Date(datetime).toISOString();
            const sessionId = localStorage.getItem('sessionId');
            const user = JSON.parse(localStorage.getItem('user'));

            try {
                const res = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionId
                    },
                    body: JSON.stringify({
                        phone: user.phone || user.login,
                        from: fromIso,
                        duration: durationHours * 3600,
                        hostIds: state.bookingHostIds || [state.selectedHost.id],
                        comment
                    })
                });

                const json = await res.json();

                if (!res.ok) {
                    if (res.status === 401) {
                        alert('Session expired. Please login again.');
                        localStorage.removeItem('sessionId');
                        localStorage.removeItem('user');
                        document.getElementById('bookingModal').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                        return;
                    }
                    throw new Error(json.error || 'Error');
                }

                msg.innerHTML = '<div style="color:var(--free)">‚úì Booking created. ID: ' + json.id + '</div>';

                setTimeout(async () => {
                    closeBookingModal();
                    state.selectedHosts.clear();
                    updateSelectedCount();
                    draw();
                    await loadHosts();
                    await loadBookings();
                    await loadMyBookings();
                }, 1500);
            } catch (err) {
                msg.innerHTML = '<div style="color:#f87171">√ó ' + err.message + '</div>';
            }
        });

        function logout() {
            localStorage.clear();
            document.getElementById('userInfo').innerHTML = '';
            document.getElementById('authBtn').innerHTML = '<i class="fas fa-user-circle"></i> <span class="hide-mobile">Login</span>';
            loadAchievements();
            loadMyBookings();
        }

        document.getElementById('authBtn').addEventListener('click', () => {
            if (isLoggedIn()) {
                logout();
            } else {
                document.getElementById('loginInput').value = '';
                document.getElementById('passwordInput').value = '';
                document.getElementById('loginError').textContent = '';
                document.getElementById('loginScreen').style.display = 'flex';
            }
        });

        document.getElementById('loginCancel').addEventListener('click', () => {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('loginError').textContent = '';
        });

        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        async function openLeaderboardModal() {
            const modal = document.getElementById('leaderboardModal');
            const content = document.getElementById('leaderboardContent');
            const monthEl = document.getElementById('leaderboardMonth');

            modal.style.display = 'flex';
            content.innerHTML = '<div style="text-align:center; padding:var(--space-xl); color:var(--muted);"><div class="spinner" style="margin:0 auto var(--space-md);"></div>Loading...</div>';

            try {
                const res = await fetch('/api/leaderboard', { cache: 'no-store' });

                if (!res.ok) {
                    throw new Error('Failed to load leaderboard');
                }

                const data = await res.json();

                if (data.month && data.year) {
                    monthEl.textContent = `${MONTH_NAMES[data.month - 1] || 'Unknown'} ${data.year}`;
                } else {
                    const now = new Date();
                    monthEl.textContent = `${MONTH_NAMES[now.getMonth()]} ${now.getFullYear()}`;
                }

                if (!data.leaders || data.leaders.length === 0) {
                    content.innerHTML = '<div style="text-align:center; padding:var(--space-xl); color:var(--muted);">No data yet</div>';
                    return;
                }

                content.innerHTML = data.leaders.map((leader, index) => {
                    const position = index + 1;
                    const isTop3 = position <= 3;
                    const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : '';
                    const hours = (leader.totalTime / 3600).toFixed(1);

                    return `
                        <div class="item" style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); ${isTop3 ? 'background: var(--accent-soft); border-color: rgba(102, 126, 234, 0.3);' : ''}">
                            <div style="font-size: 1.5rem; font-weight: 700; min-width: 48px; text-align: center;">
                                ${medal ? medal : position}
                            </div>
                            ${leader.avatarUrl ?
                            `<img src="${leader.avatarUrl}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border);" />` :
                            `<div style="width: 48px; height: 48px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: 700; border: 2px solid var(--border);">${(leader.nickname || leader.name)?.charAt(0) || '?'}</div>`
                        }
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${leader.nickname || leader.name || 'Player'}</div>
                                <div class="small" style="color: var(--muted);">ID: ${leader.userId}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.125rem; font-weight: 700; background: var(--accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${hours}h</div>
                                <div class="small" style="color: var(--muted);">total</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Failed to load leaderboard:', err);
                content.innerHTML = '<div style="text-align:center; padding:var(--space-xl); color:#f87171;">Loading error</div>';
            }
        }

        function closeLeaderboardModal() {
            document.getElementById('leaderboardModal').style.display = 'none';
        }

        document.addEventListener('click', (e) => {
            const modal = document.getElementById('leaderboardModal');
            if (e.target === modal) closeLeaderboardModal();

            const gamesModal = document.getElementById('gamesModal');
            if (e.target === gamesModal) closeGamesModal();
        });
        async function loadPayments() {
            const container = document.getElementById('payments');

            if (!isLoggedIn()) {
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px">Login to view stats</div>';
                return;
            }

            try {
                const res = await fetch('/api/payments', {
                    cache: 'no-store',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('sessionId')
                    }
                });
                const data = await res.json();

                container.innerHTML = `
            <div style="padding:14px; background:var(--glass); border-radius:10px; border:1px solid var(--border);">
                <div style="margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid var(--border);">
                    <div class="small" style="color:var(--muted); margin-bottom:4px;">Total deposits (Sep 2024+)</div>
                    <div style="font-size:24px; font-weight:700; color:var(--accent);">${data.total}‚Ç¨</div>
                </div>

                <div style="display:flex; flex-direction:column; gap:8px; font-size:13px;">
                    ${parseFloat(data.bonus) > 0 ? `
                        <div style="display:flex; justify-content:space-between;">
                            <span style="color:var(--free);">Bonus earned</span>
                            <span style="font-weight:600; color:var(--free);">+${data.bonus}‚Ç¨</span>
                        </div>
                    ` : ''}
                    ${data.count > 0 ? `
                        <div style="display:flex; justify-content:space-between;">
                            <span style="color:var(--muted);">Transactions</span>
                            <span style="font-weight:500;">${data.count}</span>
                        </div>
                    ` : ''}
                    ${parseFloat(data.average) > 0 ? `
                        <div style="display:flex; justify-content:space-between; margin-top:4px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.05);">
                            <span style="color:var(--muted);">Average check</span>
                            <span style="font-weight:500;">${data.average}‚Ç¨</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
            } catch (err) {
                console.error('Failed to load payments:', err);
                container.innerHTML = '<div class="small" style="color:var(--muted);padding:8px">Loading error</div>';
            }
        }

        async function handleLogin() {
            const loginInput = document.getElementById('loginInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorEl = document.getElementById('loginError');

            errorEl.textContent = '';

            if (!loginInput || !password) {
                errorEl.textContent = 'Fill all fields';
                return;
            }

            try {
                const r = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login: loginInput, password })
                });
                const data = await r.json();

                if (r.ok && data.success) {
                    localStorage.clear();
                    localStorage.setItem('sessionId', data.sessionId);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    const user = data.user;
                    if (user) {
                        const balance = ((user.deposit || 0) + (user.bonus || 0)).toFixed(2);
                        document.getElementById('userInfo').innerHTML = `<i class="fas fa-user"></i> ${user.nickname || ''} ‚Ä¢ <i class="fas fa-wallet" style="font-size:0.75rem;"></i> ${balance}‚Ç¨`;
                    }

                    document.getElementById('authBtn').innerHTML = '<i class="fas fa-sign-out-alt"></i> <span class="hide-mobile">Logout</span>';
                    document.getElementById('loginScreen').style.display = 'none';
                    loadAchievements();
                    loadMyBookings();
                    loadPayments();

                } else {
                    errorEl.textContent = data.error || 'Invalid login/password';
                }
            } catch (err) {
                errorEl.textContent = 'Network error';
            }
        }

        document.getElementById('loginSubmit').addEventListener('click', handleLogin);

        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        function restoreSession() {
            const user = localStorage.getItem('user');
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    if (userData) {
                        const balance = ((userData.deposit || 0) + (userData.bonus || 0)).toFixed(2);
                        document.getElementById('userInfo').innerHTML = `<i class="fas fa-user"></i> ${userData.nickname || ''} ‚Ä¢ <i class="fas fa-wallet" style="font-size:0.75rem;"></i> ${balance}‚Ç¨`;
                        document.getElementById('authBtn').innerHTML = '<i class="fas fa-sign-out-alt"></i> <span class="hide-mobile">Logout</span>';
                        loadAchievements();
                        loadMyBookings();
                    }
                } catch (e) {
                    console.error('Session restore error', e);
                }
            } else {
                loadAchievements();
                loadMyBookings();
            }
        }

        // Mouse tracking for card hover effects
        document.querySelectorAll('.card').forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                card.style.setProperty('--mouse-x', `${x}%`);
                card.style.setProperty('--mouse-y', `${y}%`);
            });
        });

        // Hide mobile text on small screens
        const style = document.createElement('style');
        style.textContent = `
            @media (max-width: 768px) {
                .hide-mobile { display: none !important; }
            }
        `;
        document.head.appendChild(style);

        // Initialize
        restoreSession();
        loadHosts();
        loadBookings();
        loadPayments();


        setInterval(() => {
            loadHosts();
            loadBookings();
        }, 30000);

        window.addEventListener('resize', () => {
            draw._fittedOnce = false;
            draw();
        });
    </script>
</body>

</html>